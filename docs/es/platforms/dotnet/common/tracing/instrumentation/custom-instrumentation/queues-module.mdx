---
title: Colas de instrumentación
sidebar_order: 3000
description: "Aprende a instrumentar manualmente tu código para usar el módulo Queues de Sentry. "
---

Sentry incluye instrumentación automática para los sistemas de colas de mensajería más comunes. Si el tuyo no es compatible, aún puedes instrumentar spans y transacciones personalizadas en torno a tus productores y consumidores de colas para asegurarte de contar con datos de rendimiento sobre tus colas de mensajería.

<div id="producer-instrumentation">
  ## Instrumentación del productor
</div>

Para empezar a capturar métricas de rendimiento, usa la función `transaction.StartChild()` para envolver los eventos de tu productor de cola. El `op` de tu span debe establecerse en `queue.publish`. Incluye los siguientes datos del span para enriquecer los spans del productor con métricas de la cola:

| Data Attribute | Type | Description |
|:--|:--|:--|
| `messaging.message.id ` | string | El identificador del mensaje |
| `messaging.destination.name` | string | El nombre de la cola o del tópico |
| `messaging.message.body.size` | int | Tamaño del cuerpo del mensaje en bytes |

El span `queue.publish` debe existir dentro de una transacción para que se reconozca como un span de productor. Si estás usando un framework compatible, la transacción la crea la integración. Si estás usando C# puro, puedes iniciar una nueva con `SentrySdk.StartTransaction()`.

También debes incluir encabezados de trazas en tu mensaje para que tus consumidores puedan continuar la traza cuando se procese tu mensaje.

```csharp
var connection = MyCustomQueue.Connect();

// El mensaje que deseas enviar a la cola
var queue = "messages";
var message = "Hello World!";
var messageId = "abc123";
var sentryTrace = SentrySdk.getTraceHeader()?.ToString();
var baggage = SentrySdk.getBaggage()?.ToString();

// Crear la transacción
var transaction = SentrySdk.StartTransaction(
    "queue_producer_transaction",
    "function"
);

// Crear el span
var span = transaction.StartChild(
    "queue.publish",
    "queue_producer"
);

// Definir los datos del span
span.SetExtra("messaging.message.id", messageId);
span.SetExtra("messaging.destination.name", queue);
span.SetExtra("messaging.message.body.size", Encoding.UTF8.GetByteCount(message));

// Publicar el mensaje en la cola (incluye la marca de tiempo actual)
var now = DateTimeOffset.UtcNow.ToUnixTimeSeconds();
connection.Publish(
    queue,
    message,
    now,
    sentryTrace,
    baggage
);

span.Finish();
transaction.Finish();
```


<div id="consumer-instrumentation">
  ## Instrumentación del consumidor
</div>

Para empezar a capturar métricas de rendimiento, usa la función `transaction.StartChild()` para envolver tus consumidores de colas. El `op` del span debe establecerse en `queue.process`. Incluye los siguientes datos del span para enriquecer tus spans de consumidor con métricas de la cola:

| Atributo de datos | Tipo | Descripción |
|:--|:--|:--|
| `messaging.message.id ` | string | El identificador del mensaje |
| `messaging.destination.name` | string | El nombre de la cola o del tópico |
| `messaging.message.body.size` | number | Tamaño del cuerpo del mensaje en bytes |
| `messaging.message.retry.count ` | number | La cantidad de veces que se intentó procesar un mensaje |
| `messaging.message.receive.latency ` | number | El tiempo en milisegundos que un mensaje esperó en la cola para ser procesado |

El span `queue.process` debe existir dentro de una transacción para que se reconozca como un span de consumidor. Si estás usando un framework compatible, la transacción la crea la integración. Si usas C# puro, puedes iniciar una nueva con `SentrySdk.StartTransaction()`.

Usa `SentrySdk.ContinueTrace()` para vincular tus spans de consumidor con sus spans de productor asociados, y `span.SetExtra()` para marcar el trace de tu mensaje como exitoso o fallido.

```csharp
var connection = MyCustomQueue.Connect();

// Obtener el mensaje de las colas
var queue = "messages";
var message = connection.Consume(queue);

// Calcular la latencia (opcional, pero útil)
var now = DateTimeOffset.UtcNow;
var messageTime = DateTimeOffset.FromUnixTimeSeconds(message["timestamp"]);
var latency = now - messageTime;

var sentryTraceHeader = message["sentry-trace"];
var sentryBaggageHeader = message["baggage"];

// Crear la transacción
var transactionContext = SentrySdk.ContinueTrace(sentryTraceHeader, sentryBaggageHeader);
var transaction = SentrySdk.StartTransaction(
    transactionContext,
    "queue_consumer_transaction",
    "function"
);

// Crear el span
var span = transaction.StartChild(
    "queue.process",
    "queue_consumer"
);

// Establecer los datos del span
span.SetExtra("messaging.message.id", message["message_id"]);
span.SetExtra("messaging.destination.name", queue);
span.SetExtra("messaging.message.body.size", Encoding.UTF8.GetByteCount(message["body"]));
span.SetExtra("messaging.message.receive.latency", latency.TotalMilliseconds);
span.SetExtra("messaging.message.retry.count", 0);

try
{
    // Procesar el mensaje
    ProcessMessage(message);
}
catch (Exception)
{
    // En caso de error, establece el estado en "internal_error"
    span.Status = SpanStatus.InternalError;
}

span.Finish();
transaction.Finish();
```
