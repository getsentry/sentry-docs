---
title: Apollo 4
caseStyle: camelCase
supportLevel: production
sdk: sentry.java.apollo-4
description: "Obtén más información sobre la integración de Sentry para Apollo 4 en el SDK de Android."
categories:
  - mobile
---

<Alert>
  Para poder capturar transacciones, primero debes <PlatformLink to="/tracing/">configurar el tracing</PlatformLink>.
</Alert>

La integración de Apollo 4 de Sentry proporciona los `SentryApollo4Interceptor` y `SentryApollo4HttpInterceptor`, que crean un span por cada solicitud HTTP saliente ejecutada con un cliente GraphQL de [Apollo Kotlin](https://github.com/apollographql/apollo-kotlin). La integración también ofrece funciones de extensión en `ApolloClient.Builder`.

<div id="install">
  ## Instalar
</div>

Instala la integración de Apollo 4:

```groovy {tabTitle:Gradle}
implementation 'io.sentry:sentry-apollo-4:{{@inject packages.version('sentry.java.apollo-4', '8.3.0') }}'
```

Para otros gestores de dependencias, consulta el [repositorio central de Maven](https://search.maven.org/artifact/io.sentry/sentry-apollo-4).

<div id="configure-with-extension">
  ## Configurar con la extensión
</div>

Agrega `Interceptors` a `ApolloClient.Builder` con `SentryApolloBuilderExtensions`:

```java
import com.apollographql.ApolloClient;
import io.sentry.apollo4.SentryApolloBuilderExtensionsKt;

ApolloClient apollo = SentryApolloBuilderExtensionsKt
    .sentryTracing(new ApolloClient.Builder())
    .serverUrl("https://tu-servidor-api/")
    .build();
```

```kotlin
import com.apollographql.ApolloClient
import io.sentry.apollo4.sentryTracing

val apollo = ApolloClient.builder()
    .serverUrl("https://tu-servidor-api/")
    .sentryTracing()
    .build()
```

<div id="manual-configuration">
  ## Configuración manual
</div>

Como los `HttpInterceptors` deben agregarse a `NetworkTransport`, los `SentryInterceptors` se deben agregar manualmente si estás usando un `NetworkTransport` personalizado:

```java
import com.apollographql.ApolloClient;
import com.apollographql.network.http.HttpNetworkTransport;
import io.sentry.apollo4.SentryApollo4HttpInterceptor;
import io.sentry.apollo4.SentryApollo4Interceptor;

ApolloClient apollo = new ApolloClient.Builder()
        .networkTransport(
            new HttpNetworkTransport.Builder()
                .serverUrl("https://tu-servidor-api/")
                .addInterceptor(new SentryApollo4HttpInterceptor())
                .build())
        .addInterceptor(new SentryApollo4Interceptor())
        .build();
```

```kotlin
import com.apollographql.ApolloClient
import io.sentry.apollo4.SentryApollo4HttpInterceptor
import io.sentry.apollo4.SentryApollo4Interceptor
import com.apollographql.network.http.HttpNetworkTransport

val apollo = ApolloClient.builder()
    .networkTransport(
        HttpNetworkTransport.Builder()
            .serverUrl("https://apollo-fullstack-tutorial.herokuapp.com/graphql")
            .addInterceptor(SentryApollo4HttpInterceptor())
            .build()
    )
    .addInterceptor(SentryApollo4Interceptor())
    .build()
```

<div id="modify-or-drop-spans">
  ## Modificar o descartar spans
</div>

Los spans creados alrededor de las solicitudes pueden modificarse o descartarse mediante `SentryApollo4HttpInterceptor.BeforeSpanCallback`, que se pasa a `SentryApollo4HttpInterceptor`, o mediante la función de extensión `sentryTracing`:

```java
import com.apollographql.ApolloClient;
import io.sentry.apollo4.SentryApolloBuilderExtensionsKt;

ApolloClient apollo = SentryApolloBuilderExtensionsKt.sentryTracing(
            new ApolloClient.Builder(),
            (span, request, response) -> {
              if ("LaunchDetails".equals(span.getOperation())) {
                span.setTag("tag-name", "tag-value");
              }
              return span;
            })
        .serverUrl("https://tu-host-api/")
        .build();
```

```kotlin
import com.apollographql.ApolloClient
import io.sentry.apollo4.sentryTracing

val apollo = ApolloClient.builder()
    .serverUrl("https://apollo-fullstack-tutorial.herokuapp.com/graphql")
    .sentryTracing { span, request, response ->
        if ("LaunchDetails" == span.operation) {
            span.setTag("tag-name", "tag-value")
        }
        span
    }
    .build()
```

<div id="graphql-client-errors">
  ## Errores del cliente GraphQL
</div>

Esta función captura automáticamente los errores del cliente GraphQL (como operaciones inválidas y códigos de respuesta) como eventos de error y los envía a Sentry. El evento de error incluirá los datos de `request` y `response`, entre ellos `url`, `status_code` y `data` (la `query` convertida a cadena).

Sentry agrupará los errores del cliente GraphQL por `operationName`, `operationType` y `statusCode`, para que puedas ver fácilmente cuántos errores ocurrieron en cada caso.

Esta función está habilitada de forma predeterminada y puede deshabilitarse estableciendo la opción `captureFailedRequests` en `false`:

```kotlin
import com.apollographql.ApolloClient
import io.sentry.apollo4.sentryTracing

val apollo = ApolloClient.builder()
    .serverUrl("https://your-api-host/")
    .sentryTracing(captureFailedRequests = false)
    .build()
```

De forma predeterminada, solo se capturarán como eventos de error los errores del cliente de GraphQL cuya respuesta incluya el arreglo [errors](https://spec.graphql.org/October2021/#sec-Errors).

Los errores del cliente de GraphQL de cualquier destino (expresión regular `.*`) se capturan automáticamente, pero puedes cambiar este comportamiento configurando la opción `failedRequestTargets` con una expresión regular o con una cadena de texto simple (`String`). Una cadena simple debe contener al menos uno de los elementos de la lista. Las cadenas simples no tienen que ser coincidencias exactas: la URL de una solicitud se considera coincidente cuando contiene una cadena proporcionada mediante la opción.

```kotlin
import com.apollographql.ApolloClient
import io.sentry.apollo4.sentryTracing

val apollo = ApolloClient.builder()
    .serverUrl("https://your-api-host/")
    .sentryTracing(captureFailedRequests = true, failedRequestTargets = listOf("myapi.com"))
    .build()
```

De forma predeterminada, los eventos de error no incluirán `Headers` ni `Cookies`, pero puedes cambiar este comportamiento configurando la opción `sendDefaultPii` en `true`:

```kotlin
Sentry.init { options ->
  options.isSendDefaultPii = true
}
```

```xml {filename:AndroidManifest.xml}
<application>
  <meta-data android:name="io.sentry.send-default-pii" android:value="true" />
</application>
```

Los eventos de error incluirán los cuerpos sin procesar de las solicitudes y respuestas de GraphQL, que pueden contener datos sensibles. Para evitarlo, parametriza tus consultas usando el campo [variables](https://spec.graphql.org/October2021/#sec-Language.Variables). Luego, [Relay](/es/product/relay) ejecutará la [limpieza de datos PII](/es/product/relay/#pii-data-scrubbing), transformando automáticamente los valores en “[Filtered]”.

Como alternativa, puedes personalizar el evento y depurar los datos tú mismo.

<div id="customize-or-drop-the-error-event">
  ### Personalizar o descartar el evento de error
</div>

El evento de error capturado puede personalizarse o descartarse con un `BeforeSendCallback`:

```kotlin
import io.sentry.Sentry
import io.sentry.SentryOptions.BeforeSendCallback
import com.apollographql.api.http.HttpRequest
import com.apollographql.api.http.HttpResponse
import io.sentry.TypeCheckHint.APOLLO_REQUEST
import io.sentry.TypeCheckHint.APOLLO_RESPONSE

Sentry.init { options ->
  // Agrega un callback que se utilizará antes de enviar el evento a Sentry.
  // Con este callback, puedes modificar el evento o descartarlo devolviendo null.
  options.beforeSend = BeforeSendCallback { event, hint ->
    val request = hint.getAs(APOLLO_REQUEST, HttpRequest::class.java)
    val response = hint.getAs(APOLLO_RESPONSE, HttpResponse::class.java)

    // personaliza o descarta el evento
    event
  }
}
```

<div id="automatically-and-manually-captured-graphql-client-errors">
  ### Errores del cliente GraphQL capturados automática y manualmente
</div>

Cuando `captureFailedRequests` está habilitado, algunas bibliotecas de cliente de GraphQL lanzan excepciones no comprobadas, como `ApolloException` y sus implementaciones. Esto significa que el evento de error lo capturarán tanto la biblioteca de cliente de GraphQL como el SDK de Sentry para Android. Para evitarlo, recomendamos identificar estos errores y usar el método `Sentry.captureException` en lugar de capturarlos manualmente:

```kotlin
import io.sentry.Sentry
import com.apollographql.exception.ApolloException

try {
  // Si esta llamada a la API devuelve el array `errors`, se capturará como un evento de error por el `SentryApollo4HttpInterceptor`.
  return apolloClient.query(LaunchDetailsQuery(launchId)).execute()
} catch (e: ApolloException) {
  // No captures manualmente esta excepción para evitar eventos de error duplicados.
  // Sentry.captureException(e)
}
```
