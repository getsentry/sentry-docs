---
title: Instrumentar colas
description: "Aprende a instrumentar manualmente tu código para usar el módulo Queues de Sentry"
sidebar_order: 20
supported:
  - javascript.node
  - javascript.aws-lambda
  - javascript.azure-functions
  - javascript.connect
  - javascript.express
  - javascript.fastify
  - javascript.gcp-functions
  - javascript.hapi
  - javascript.hono
  - javascript.koa
  - javascript.nestjs
  - javascript.bun
  - javascript.deno
  - javascript.nextjs
  - javascript.nuxt
  - javascript.astro
  - javascript.solidstart
  - javascript.sveltekit
  - javascript.remix
  - javascript.cloudflare
  - javascript.tanstackstart-react
---

Para asegurarte de contar con datos de rendimiento sobre tus colas de mensajería, necesitarás instrumentar spans y transacciones personalizados en torno a los productores y consumidores de tus colas.

<div id="producer-instrumentation">
  ## Instrumentación del productor
</div>

Para empezar a capturar métricas de rendimiento, usa la función `Sentry.startSpan` para envolver los eventos de tu productor de colas. El `op` de tu span debe configurarse como `queue.publish`. Incluye los siguientes atributos para enriquecer los spans del productor con métricas de cola:

| Atributo                      | Tipo   | Descripción                         |
| :---------------------------- | :----- | :---------------------------------- |
| `messaging.message.id `       | string | Identificador del mensaje           |
| `messaging.destination.name`  | string | Nombre de la cola o del tema        |
| `messaging.message.body.size` | int    | Tamaño del cuerpo del mensaje en bytes |

También debes incluir encabezados de trazas en tu mensaje usando `spanToTraceHeader` y `spanToBaggageHeader` para que los consumidores puedan continuar tu traza una vez que se recoja el mensaje.

<Alert>
  El span `queue.publish` debe existir como hijo dentro de un span padre para que se reconozca como un span de productor. Si aún no tienes un span de productor padre, puedes iniciar uno nuevo usando `Sentry.startSpan`.
</Alert>

```javascript {filename:my-queue.js}
app.post("/publish", async (req, res) => {
  // El controlador de la ruta instrumenta automáticamente un span padre
  await Sentry.startSpan(
    {
      name: "queue_producer",
      op: "queue.publish",
      attributes: {
        "messaging.message.id": messageId,
        "messaging.destination.name": "messages",
        "messaging.message.body.size": messageBodySize,
      },
    },
    async () => {
      const { "sentry-trace": sentryTrace, baggage: sentryBaggage } =
        Sentry.getTraceData();
      await redisClient.lPush(
        "messages",
        JSON.stringify({
          sentryTrace,
          sentryBaggage,
          timestamp: Date.now(),
          messageId,
        })
      );
    }
  );
});
```


<div id="consumer-instrumentation">
  ## Instrumentación del consumidor
</div>

Para empezar a capturar métricas de rendimiento, usa la función `Sentry.startSpan` para envolver tus consumidores de cola. El `op` de tu span debe establecerse en `queue.process`. Incluye los siguientes atributos para enriquecer los spans del consumidor con métricas de la cola:

| Atributo                             | Tipo   | Descripción                                                         |
| :----------------------------------- | :----- | :------------------------------------------------------------------ |
| `messaging.message.id `              | string | El identificador del mensaje                                        |
| `messaging.destination.name`         | string | El nombre de la cola o del tópico                                   |
| `messaging.message.body.size`        | number | Tamaño del cuerpo del mensaje en bytes                              |
| `messaging.message.retry.count `     | number | La cantidad de veces que se intentó procesar un mensaje             |
| `messaging.message.receive.latency ` | number | El tiempo en milisegundos que un mensaje esperó en la cola antes de procesarse |

Usa `Sentry.continueTrace` para conectar los spans del consumidor con sus spans de productor asociados, y `setStatus` para marcar el trace de tu mensaje como exitoso o fallido.

<Alert>
  Tu span `queue.process` debe existir como hijo dentro de un span padre para que se reconozca como un span de consumidor. Si no tienes un span padre, puedes crear uno para envolver el span del consumidor usando `Sentry.startSpan`.
</Alert>

```javascript {filename:my-consumer.js}
const message = JSON.parse(await redisClient.lPop(QUEUE_KEY));
const latency = Date.now() - message.timestamp;

Sentry.continueTrace(
    { sentryTrace: message.sentryTrace, baggage: message.sentryBaggage },
    () => {
        Sentry.startSpan({
                name: 'transacción_consumidor_cola',
            },
            (parent) => {
                Sentry.startSpan({
                    name: 'consumidor_cola',
                    op: 'queue.process',
                    attributes: {
                        'messaging.message.id': message.messageId,
                        'messaging.destination.name': 'messages',
                        'messaging.message.body.size': message.messageBodySize,
                        'messaging.message.receive.latency': latency,
                        'messaging.message.retry.count': 0,
                    }
                }, (span) => {
                    ... // Continuar con el procesamiento del mensaje
                    parent.setStatus({code: 1, message: 'ok'});
                });
            },
        ),
    },
)
```
