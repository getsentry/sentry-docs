---
title: Detección de bloqueo del Event Loop
sidebar_order: 70
description: "Supervisa los event loops bloqueados en aplicaciones Electron"
keywords:
  [
    "anr",
    "Application Not Responding",
    "Event Loop Blocked",
    "Event Loop Stalls",
  ]
---

Los errores de bloqueo del Event Loop, o errores de Application Not Responding (ANR),
se producen cuando el event loop de los procesos principal o de renderizado de Electron
permanece bloqueado más tiempo que el umbral configurado. El SDK de Electron informa los
errores ANR como eventos de Sentry y puede adjuntar una traza de pila del código que provoca
el bloqueo al evento ANR.

<Include name="feature-stage-beta.mdx" />

_(Disponible a partir de la versión 6.9.0)_

La detección de bloqueo del event loop puede habilitarse de forma individual para los procesos
principal y de renderizado.

<div id="main-process">
  # Proceso principal:
</div>

<div id="installation">
  ## Instalación
</div>

Instala `@sentry/node-native` para usar `eventLoopBlockIntegration` en el proceso principal.

```bash {tabTitle:npm}
npm install @sentry/node-native
```

```bash {tabTitle:yarn}
yarn add @sentry/node-native
```

```bash {tabTitle:pnpm}
pnpm add @sentry/node-native
```


<div id="usage">
  ## Uso
</div>

```javascript
import * as Sentry from "@sentry/electron/main";
import { eventLoopBlockIntegration } from "@sentry/electron/native";

Sentry.init({
  dsn: "___PUBLIC_DSN___",
  integrations: [eventLoopBlockIntegration({ threshold: 500 })],
});
```


<div id="configuration-options">
  ## Opciones de configuración
</div>

```typescript
export interface ThreadBlockedIntegrationOptions {
  /**
   * Umbral en milisegundos para activar un evento.
   *
   * El valor predeterminado es 1000ms.
   */
  threshold: number;
  /**
   * Número máximo de eventos bloqueados a enviar por hora.
   *
   * El valor predeterminado es 1.
   */
  maxEventsPerHour: number;
  /**
   * Etiquetas para incluir con los eventos bloqueados.
   */
  staticTags: { [key: string]: Primitive };
}
```


<div id="renderer-processes">
  # Procesos de renderizado:
</div>

```javascript
import * as Sentry from "@sentry/electron/renderer";

Sentry.init({
  dsn: "___PUBLIC_DSN___",
  anrDetection: { captureStackTrace: true },
});
```


<div id="configuration-options">
  ## Opciones de configuración
</div>

Puedes pasar un objeto de configuración para `anrDetection` en el renderizador para
personalizar el comportamiento de la detección de ANR.

```Typescript
interface Options {
  /**
   * Intervalo para enviar mensajes de heartbeat al proceso hijo.
   *
   * Proceso principal: Por defecto 50ms.
   * Proceso de renderizado: Por defecto 1000ms.
   */
  pollInterval: number;
  /**
   * Umbral en milisegundos para activar un evento ANR.
   *
   * Por defecto 5000ms.
   */
  anrThreshold: number;
  /**
   * Indica si se debe capturar un stack trace cuando se activa el evento ANR.
   *
   * Por defecto `false`.
   */
  captureStackTrace: boolean;
}
```


<div id="event-loop-block-detection-implementation-and-overhead">
  ## Implementación de la detección de bloqueos del event loop y sobrecarga
</div>

En el proceso principal, `eventLoopBlockIntegration` utiliza un módulo nativo para
rastrear hilos y capturar trazas de pila mediante las API nativas de V8. Se usa un hilo worker
para capturar eventos incluso si el hilo principal está bloqueado. La sobrecarga sin
bloqueo del event loop debería ser mínima. Cada hilo notifica al módulo nativo
que sigue activo cada `threshold / 2` milisegundos. Una vez que se detecta un bloqueo del event loop,
se utilizan las API nativas de V8 para pausar todos los hilos y capturar trazas de pila.
El tiempo de pausa se considera poco significativo si el event loop ya ha estado
bloqueado durante cientos de milisegundos.

En los procesos del renderer, se utiliza un mecanismo de sondeo similar para detectar
bloqueos del event loop. En Electron v34 o posterior, la API
[`frame.collectJavaScriptCallStack()`](https://www.electronjs.org/docs/latest/api/web-frame-main#framecollectjavascriptcallstack-experimental)
se utiliza para capturar trazas de pila cuando se detecta un bloqueo del event loop. En
versiones de Electron más antiguas, se utiliza la API del inspector de V8 para capturar trazas de pila.
La API del inspector puede tener un ligero impacto negativo en el rendimiento, ya que puede
hacer que V8 desoptimice algunas rutas de código. Por esta razón, recomendamos actualizar
a Electron v34 o posterior para usar esta función en producción.