---
title: Ciclo de vida de los spans
description: "Aprende a añadir atributos a los spans en Sentry para supervisar el rendimiento y depurar aplicaciones."
sidebar_order: 10
---

<Alert>
  Para capturar transacciones y spans personalizados según las necesidades de tu organización, primero debes <PlatformLink to="/tracing/">configurar el tracing.</PlatformLink>
</Alert>

Para añadir datos de rendimiento personalizados a tu aplicación, necesitas incorporar instrumentación personalizada en forma de [spans](/es/concepts/key-terms/tracing/distributed-tracing/#traces-transactions-and-spans). Los spans son una forma de medir el tiempo que tarda en producirse una acción específica. Por ejemplo, puedes crear un span para medir el tiempo que tarda en ejecutarse una función.

<PlatformContent includePath="enriching-events/import" />

<div id="span-lifecycle">
  ## Ciclo de vida de un span
</div>

En Python, los spans suelen crearse con un administrador de contexto, que gestiona automáticamente su ciclo de vida. Al crear un span con un administrador de contexto, este se inicia automáticamente al entrar en el contexto y finaliza al salir de él. Este es el enfoque recomendado en la mayoría de los casos.

```python
import sentry_sdk

# Inicia un span para una tarea
with sentry_sdk.start_span(op="task", name="Crear usuario"):
    # Tu código aquí
    # El span se cerrará automáticamente al salir de este bloque
    user = create_user(email="user@example.com")
    send_welcome_email(user)
    # El span se cierra automáticamente aquí cuando finaliza el bloque 'with'
```

Puedes invocar los métodos `__enter__` y `__exit__` del administrador de contexto para controlar de manera más explícita el ciclo de vida del span.

<div id="span-context-and-nesting">
  ## Contexto y anidación de spans
</div>

Cuando creas un span, pasa a ser hijo del span activo. Esto te permite construir una jerarquía de spans que representan el recorrido de ejecución de tu aplicación:

```python
import sentry_sdk

with sentry_sdk.start_span(op="process", name="Process Data"):
    # Este código se registra en el span "Process Data"

    with sentry_sdk.start_span(op="task", name="Validate Input"):
        # Ahora esto es un span secundario de "Process Data"
        validate_data()

    with sentry_sdk.start_span(op="task", name="Transform Data"):
        # Otro span secundario
        transform_data()
```

<div id="span-starting-options">
  ## Opciones iniciales de span
</div>

Las siguientes opciones se pueden usar al crear spans:

| Opción        | Tipo            | Descripción                                     |
| ------------- | --------------- | ----------------------------------------------- |
| `op`          | `string`        | La operación del span.                          |
| `name`        | `string`        | El nombre del span.                             |
| `start_timestamp`  | `datetime/float`| La marca de tiempo de inicio del span.         |

<div id="using-the-context-manager">
  ## Uso del administrador de contexto
</div>

Para la mayoría de los casos, recomendamos usar el enfoque del administrador de contexto con `sentry_sdk.start_span()`. Esto crea un nuevo span que se inicia automáticamente al entrar en el contexto y termina al salir de él.

```python
import sentry_sdk

with sentry_sdk.start_span(op="db", name="Consulta de usuarios") as span:
    # Realiza una consulta a la base de datos
    users = db.query("SELECT * FROM users")

    # Puedes añadir datos al span
    span.set_data("user_count", len(users))
```

El gestor de contexto también maneja correctamente las excepciones y marca el span como fallido si se produce una:

```python
import sentry_sdk

try:
    with sentry_sdk.start_span(op="http", name="Call External API"):
        # Si esto genera una excepción, el span se marcará como fallido
        response = requests.get("https://api.example.com/data")
        response.raise_for_status()
except Exception:
    # El span ya está marcado como fallido y ha finalizado
    pass
```

<div id="getting-the-current-span">
  ## Obtener el span actual
</div>

Puedes acceder al span activo actualmente con `sentry_sdk.get_current_span()`:

```python
import sentry_sdk

# Obtener el span activo actual
current_span = sentry_sdk.get_current_span()
if current_span:
    current_span.set_data("key", "value")
```

<div id="working-with-transactions">
  ## Trabajar con transacciones
</div>

Las [transacciones](/es/product/insights/overview/transaction-summary/#what-is-a-transaction) son un tipo especial de span que representan una operación completa en tu aplicación, como una solicitud web. Puedes crear transacciones explícitamente:

```python
import sentry_sdk

with sentry_sdk.start_transaction(name="Background Task", op="task") as transaction:
    # Tu código aquí

    # Puedes añadir spans hijos a la transacción
    with sentry_sdk.start_span(op="subtask", name="Data Processing"):
        # Procesar datos
        pass
```

<div id="improving-span-data">
  ## Mejora de los datos de spans
</div>

<div id="adding-span-attributes">
  ### Añadir atributos de span
</div>

Los atributos de span personalizan la información que puedes obtener mediante el rastreo. Esta información se encuentra en las vistas de trazas de Sentry, una vez que profundizas en un span. Puedes capturar contexto adicional con atributos de span. Estos pueden ser pares clave-valor de varios tipos de Python.

```python
import sentry_sdk

with sentry_sdk.start_span(op="db", name="Consulta de usuarios") as span:
    # Ejecuta la consulta
    users = db.query("SELECT * FROM users WHERE active = true")

    # Puedes añadir más datos durante la ejecución
    span.set_data("result_count", len(users))
```

También puedes añadir atributos a un span existente:

```python
import sentry_sdk

# Obtener el span actual
span = sentry_sdk.get_current_span()
if span:
    # Establecer datos individuales
    span.set_data("user_id", user.id)
    span.set_data("request_size", len(request.body))
```

<div id="adding-attributes-to-all-spans">
  ### Agregar atributos a todos los spans
</div>

Para agregar atributos a todos los spans, usa el callback `before_send_transaction`:

```python
import sentry_sdk
from sentry_sdk.types import Event, Hint

def before_send_transaction(event: Event, hint: Hint) -> Event | None:
    # Agrega atributos al span raíz (transacción)
    if "trace" in event.get("contexts", {}):
        if "data" not in event["contexts"]["trace"]:
            event["contexts"]["trace"]["data"] = {}

        event["contexts"]["trace"]["data"].update({
            "app_version": "1.2.3",
            "environment_region": "us-west-2"
        })

    # Agrega atributos a todos los spans hijos
    for span in event.get("spans", []):
        if "data" not in span:
            span["data"] = {}

        span["data"].update({
            "component_version": "2.0.0",
            "deployment_stage": "production"
        })

    return event

sentry_sdk.init(
    # ...
    before_send_transaction=before_send_transaction
)
```

### Agregar operaciones de span (&quot;op&quot;)

Los spans pueden tener una operación asociada, lo que ayuda a Sentry a comprender el contexto del span. Por ejemplo, los spans relacionados con bases de datos tienen la operación `db`, mientras que las solicitudes HTTP usan `http.client`.

Sentry mantiene una [lista de operaciones de span bien conocidas](https://develop.sentry.dev/sdk/performance/span-operations/#list-of-operations) que deberías usar cuando corresponda:

```python
import sentry_sdk

# Operación del cliente HTTP
with sentry_sdk.start_span(op="http.client", name="Obtener datos del usuario"):
    response = requests.get("https://api.example.com/users")

# Operación de base de datos
with sentry_sdk.start_span(op="db", name="Guardar usuario"):
    db.execute(
        "INSERT INTO users (name, email) VALUES (%s, %s)",
        (user.name, user.email),
    )

# Operación de E/S de archivos
with sentry_sdk.start_span(op="file.read", name="Leer la configuración"):
    with open("config.json", "r") as f:
        config = json.load(f)
```

<div id="updating-the-span-status">
  ### Actualizar el estado del span
</div>

Puedes actualizar el estado de un span para indicar si se completó correctamente o si falló:

```python
import sentry_sdk

with sentry_sdk.start_span(op="task", name="Procesar pago") as span:
    try:
        result = process_payment(payment_id)
        if result.success:
# Marcar el span como correcto
            span.set_status("ok")
        else:
# Marcar el span como error
            span.set_status("error")
            span.set_data("error_reason", result.error)
    except Exception:
# El span se marcará automáticamente como error cuando ocurra una excepción
        raise
```
