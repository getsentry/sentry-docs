---
title: Instrumentar agentes de IA
sidebar_order: 500
description: "Aprende a instrumentar manualmente tu código para usar el módulo Agents de Sentry."
---

Con <Link to="/product/insights/ai/agents/dashboard/">Sentry AI Agent Monitoring</Link>, puedes monitorear y depurar tus sistemas de IA con contexto de pila completa. Podrás hacer un seguimiento de información clave como el uso de tokens, la latencia, el uso de herramientas y las tasas de error. Los datos de AI Agent Monitoring estarán totalmente conectados con tus otros datos de Sentry, como registros, errores y trazas.

Como requisito previo para configurar AI Agent Monitoring con Python, primero necesitas <PlatformLink to="/tracing/">configurar el trazado</PlatformLink>. Una vez hecho esto, el SDK de Python instrumentará automáticamente los agentes de IA creados con las bibliotecas compatibles. Si eso no se ajusta a tu caso de uso, puedes usar la instrumentación personalizada que se describe a continuación.

<div id="automatic-instrumentation">
  ## Instrumentación automática
</div>

El SDK de Python admite la instrumentación automática para algunas bibliotecas de IA. Recomendamos añadir sus integraciones a tu configuración de Sentry para capturar automáticamente spans de agentes de IA.

* <PlatformLink to="/integrations/anthropic/">Anthropic</PlatformLink>
* <PlatformLink to="/integrations/google-genai/">Google Gen AI</PlatformLink>
* <PlatformLink to="/integrations/openai/">OpenAI</PlatformLink>
* <PlatformLink to="/integrations/openai-agents/">OpenAI Agents SDK</PlatformLink>
* <PlatformLink to="/integrations/langchain/">LangChain</PlatformLink>
* <PlatformLink to="/integrations/langgraph/">LangGraph</PlatformLink>
* <PlatformLink to="/integrations/litellm/">LiteLLM</PlatformLink>
* <PlatformLink to="/integrations/pydantic-ai/">Pydantic AI</PlatformLink>

<div id="manual-instrumentation">
  ## Instrumentación manual
</div>

Para que los datos de tus agentes de IA aparezcan en [AI Agents Insights de Sentry](https://sentry.io/orgredirect/organizations/:orgslug/insights/ai/agents/), deben crearse dos spans con nombres y atributos de datos bien definidos. Consulta a continuación.

El decorador [@sentry&#95;sdk.trace()](/es/platforms/python/tracing/instrumentation/custom-instrumentation/#span-templates) también puede usarse para crear estos spans.

<div id="spans">
  ## Tramos
</div>

<div id="invoke-agent-span">
  ### Intervalo de invocación del agente
</div>

<Include name="tracing/ai-agents-module/invoke-agent-span" />

<div id="example-invoke-agent-span">
  #### Ejemplo de tramo de invocación del agente:
</div>

```python
import sentry_sdk

sentry_sdk.init(...)

# implementación de agente de ejemplo para demostración
my_agent = MyAgent(
    name="Weather Agent",
    model_provider="openai",
    model="o3-mini",
)

with sentry_sdk.start_span(
    op="gen_ai.invoke_agent",
    name=f"invoke_agent {my_agent.name}",
) as span:
    # establecer datos sobre el LLM y el agente
    span.set_data("gen_ai.operation.name", "invoke_agent")
    span.set_data("gen_ai.system", my_agent.model_provider)
    span.set_data("gen_ai.request.model", my_agent.model)
    span.set_data("gen_ai.agent.name", my_agent.name)

    # ejecutar el agente
    result = my_agent.run()

    # establecer la respuesta del agente
    # suponemos que result.output es un diccionario
    # el tipo de `gen_ai.response.text` debe ser una cadena
    span.set_data("gen_ai.response.text", json.dumps([result.output]))

    # establecer el uso de tokens
    # suponemos que el resultado incluye los tokens usados
    span.set_data("gen_ai.usage.input_tokens", result.usage.input_tokens)
    span.set_data("gen_ai.usage.output_tokens", result.usage.output_tokens)
```

<div id="ai-client-span">
  ### Span del cliente de IA
</div>

<Include name="tracing/ai-agents-module/ai-client-span" />

<div id="example-ai-client-span">
  #### Ejemplo de intervalo del cliente de IA
</div>

```python
import sentry_sdk

sentry_sdk.init(...)

# implementación de ejemplo para demostración
my_ai = MyAI(
    model_provider="openai",
    model="o3-mini",
    model_config={
        "temperature": 0.1,
        "presence_penalty": 0.5,
    }
)

with sentry_sdk.start_span(
    op="gen_ai.chat",
    name=f"chat {my_ai.model}",
) as span:
    # establecer datos sobre el LLM
    span.set_data("gen_ai.operation.name", "chat")
    span.set_data("gen_ai.system", my_ai.model_provider)
    span.set_data("gen_ai.request.model", my_ai.model)

    # configurar los mensajes para el LLM
    max_tokens = 1024
    prompt = "Cuéntame un chiste"
    messages = [
        {"role": "user", "content": prompt},
    ]

    # establecer los datos de la solicitud de chat
    span.set_data("gen_ai.request.message", json.dumbs(messages))
    span.set_data("gen_ai.request.max_tokens", max_tokens)
    span.set_data(
        "gen_ai.request.temperature",
        my_ai.model_config.get("temperature"),
    )
    span.set_data(
        "gen_ai.request.presence_penalty",
        my_ai.model_config.get("presence_penalty"),
    )

    # consultar al LLM
    result = my_ai.messages.create(
        messages=messages,
        max_tokens=max_tokens,
    )

    # establecer la respuesta
    # asumimos que result.output es un diccionario
    # el tipo de `gen_ai.response.text` debe ser una cadena
    span.set_data("gen_ai.response.text", json.dumps([result.output]))

    # establecer el uso de tokens
    # asumimos que el resultado incluye los tokens usados
    span.set_data("gen_ai.usage.input_tokens", result.usage.input_tokens)
    span.set_data("gen_ai.usage.output_tokens", result.usage.output_tokens)
```

<div id="execute-tool-span">
  ### Intervalo de ejecución de herramienta
</div>

<Include name="tracing/ai-agents-module/execute-tool-span" />

<div id="example-execute-tool-span">
  #### Ejemplo de tramo de Execute Tool
</div>

```python
import sentry_sdk

sentry_sdk.init(...)

# implementación de ejemplo para fines de demostración
my_ai = MyAI(
    model_provider="openai",
    model="o3-mini",
)

with sentry_sdk.start_span(op="gen_ai.chat", ...):
    #  .. algo de código ..
    result = my_ai.messages.create(
        messages=messages,
        max_tokens=1024,
    )
    # .. algo de código ..

# suponemos que el LLM nos indica invocar una herramienta en el resultado
if my_should_call_tool(result):
    # analizamos el resultado para saber qué herramienta invocar
    tool = my_get_tool_to_call(result)

    with sentry_sdk.start_span(
        op="gen_ai.execute_tool",
        name=f"execute_tool {tool.name}"
    ) as span:
        # establecer datos sobre el LLM y la herramienta
        span.set_data("gen_ai.system", my_ai.model_provider)
        span.set_data("gen_ai.request.model", my_ai.model)
        span.set_data("gen_ai.tool.type", "function")
        span.set_data("gen_ai.tool.name", tool.name)
        span.set_data("gen_ai.tool.description", tool.description)

        # ejecutar la herramienta
        tool_result = my_run_tool(tool)

        # establecer el resultado de la herramienta
        span.set_data("gen_ai.tool.output", json.dumps(tool_result))
```

<div id="handoff-span">
  ### Span de transferencia
</div>

<Include name="tracing/ai-agents-module/handoff-span" />

<div id="example-handoff-span">
  #### Ejemplo de intervalo de handoff
</div>

```python
import sentry_sdk

sentry_sdk.init(...)

# implementación de agente de ejemplo para demostración
my_agent = MyAgent(
    name="Agente del tiempo",
    model_provider="openai",
    model="o3-mini",
)

with sentry_sdk.start_span(op="gen_ai.invoke_agent", ...):
    #  .. algo de código ..
    result = my_agent.run()
    #  .. algo de código ..


# suponemos que el LLM nos indica hacer un traspaso a otro agente
if my_should_handoff(result):
    # analizamos el resultado para saber a qué agente hacer el traspaso
    other_agent = my_get_agent(result)

    with sentry_sdk.start_span(
        op="gen_ai.handoff",
        name=f"traspaso de {my_agent.name} a {other_agent.name}",
    ):
        # el span de traspaso solo marca el traspaso
        pass

    with sentry_sdk.start_span(op="gen_ai.invoke_agent", ...):
        #  .. algo de código ..
        other_agent.run()
        #  .. algo de código ..
```

<div id="common-span-attributes">
  ## Atributos comunes de los spans
</div>

<Include name="tracing/ai-agents-module/common-span-attributes" />