---
title: Envío de métricas de spans
description: "Aprende a agregar atributos a los spans en Sentry para monitorear el rendimiento y depurar aplicaciones"
sidebar_order: 20
---

<Alert>

Para usar métricas de spans, primero debes <PlatformLink to="/tracing/">configurar el tracing</PlatformLink> en tu aplicación.

</Alert>

Las métricas de spans te permiten ampliar las métricas predeterminadas que recopila el tracing y hacer un seguimiento de datos de rendimiento personalizados e información de depuración dentro de los traces de tu aplicación. Hay dos enfoques principales para instrumentar métricas:

1. [Agregar métricas a spans existentes](#adding-metrics-to-existing-spans)
2. [Crear spans dedicados con métricas personalizadas](#creating-dedicated-metric-spans)

<div id="adding-metrics-to-existing-spans">
  ## Añadir métricas a spans existentes
</div>

Puedes enriquecer spans existentes con métricas personalizadas agregando datos. Esto es útil cuando quieres complementar la instrumentación automática o añadir datos contextuales a spans que ya creaste.

```python
span = sentry_sdk.get_current_span()
if span:
    # Agrega métricas individuales
    span.set_data("database.rows_affected", 42)
    span.set_data("cache.hit_rate", 0.85)
    span.set_data("memory.heap_used", 1024000)
    span.set_data("queue.length", 15)
    span.set_data("processing.duration_ms", 127)
```


<div id="best-practices-for-span-data">
  ### Mejores prácticas para datos de span
</div>

Al agregar métricas como datos de span:

- Usa convenciones de nomenclatura coherentes (por ejemplo, `category.metric_name`)
- Mantén los nombres de los atributos concisos pero descriptivos
- Usa tipos de datos adecuados (string, number, boolean o un array que contenga solo uno de estos tipos)

<div id="creating-dedicated-metric-spans">
  ## Creación de spans de métricas dedicados
</div>

Para operaciones, tareas o seguimiento de procesos más detallados, puedes crear spans dedicados personalizados centrados en las métricas o atributos específicos que quieras seguir. Este enfoque mejora la capacidad de descubrimiento y permite configuraciones de spans más precisas; sin embargo, también puede generar más ruido en la cascada de trazas.

```python
with sentry_sdk.start_span(
    op="db.metrics",
    name="Métricas de consultas de base de datos"
) as span:
    # Define las métricas después de crear el span
    span.set_data("db.query_type", "SELECT")
    span.set_data("db.table", "users")
    span.set_data("db.execution_time_ms", 45)
    span.set_data("db.rows_returned", 100)
    span.set_data("db.connection_pool_size", 5)
    # Tu operación de base de datos aquí
    pass
```

Para ver ejemplos detallados sobre cómo implementar métricas de spans en escenarios comunes, consulta nuestra guía <PlatformLink to="/tracing/span-metrics/examples/">Ejemplos de métricas de spans</PlatformLink>.


<div id="adding-metrics-to-all-spans">
  ## Añadir métricas a todos los spans
</div>

Para agregar métricas de forma uniforme en todos los spans de tu aplicación, puedes usar el callback `before_send_transaction`:

```python
import sentry_sdk
from sentry_sdk.types import Event, Hint

def before_send_transaction(event: Event, hint: Hint) -> Event | None:
    # Añadir métricas al span raíz
    if "trace" in event.get("contexts", {}):
        if "data" not in event["contexts"]["trace"]:
            event["contexts"]["trace"]["data"] = {}

        event["contexts"]["trace"]["data"].update({
            "app.version": "1.2.3",
            "environment.region": "us-west-2"
        })

    # Añadir métricas a todos los spans hijos
    for span in event.get("spans", []):
        if "data" not in span:
            span["data"] = {}

        span["data"].update({
            "app.component_version": "2.0.0",
            "app.deployment_stage": "production"
        })

    return event

sentry_sdk.init(
    # ...
    before_send_transaction=before_send_transaction
)
```

Para ver ejemplos detallados sobre cómo implementar métricas de spans en escenarios comunes, consulta nuestra guía <PlatformLink to="/tracing/span-metrics/examples/">Ejemplos de métricas de spans</PlatformLink>.
