---
title: Instrumentación automática
sidebar_order: 10
supported:
  - rust
description: "Descubre qué transacciones captura automáticamente la instrumentación."
---

<Alert>
  Para capturar transacciones, primero debes <PlatformLink to="/tracing/">configurar el tracing</PlatformLink> si aún no lo has hecho.
</Alert>

<div id="tracing-integration">
  ## Integración de `tracing`
</div>

El SDK de Rust ofrece una integración con el ecosistema de `tracing` que rastrea automáticamente los spans de cada función anotada con `#[tracing::instrument]`.

La integración se encarga de iniciar una nueva transacción o un nuevo span secundario de una transacción ya en ejecución, y establece automáticamente el span creado como el span actual.

```rust
fn main() {
    tracing_subscriber::Registry::default()
        .with(sentry::integrations::tracing::layer())
        .init();

    let _guard = sentry::init(sentry::ClientOptions {
        release: sentry::release_name!(),
        traces_sample_rate: 1.0,
        // Captura las direcciones IP de los usuarios y encabezados potencialmente sensibles al usar integraciones de servidor HTTP
        // consulta https://docs.sentry.io/platforms/rust/data-management/data-collected para obtener más información
        send_default_pii: true,
        ..Default::default()
    });

    main_span1();
}

#[tracing::instrument]
fn main_span1() {
    thread::sleep(Duration::from_millis(50));

    main_span2()
}

#[tracing::instrument]
fn main_span2() {
    thread::sleep(Duration::from_millis(200));
}
```

<div id="opentelemetry-integration">
  ## Integración con OpenTelemetry
</div>

El SDK de Rust ofrece una integración con el ecosistema de OpenTelemetry.
La integración puede capturar automáticamente [spans/transacciones](/es/concepts/key-terms/tracing/distributed-tracing/#traces-transactions-and-spans) de Sentry por cada span creado a través de la API de OpenTelemetry, con soporte para [trazado distribuido](/es/concepts/key-terms/tracing/distributed-tracing/).
La integración también captura errores con las asociaciones correctas de span y trace.

Para que esta integración funcione como se espera, solo debe usarse la API de trazado de OpenTelemetry para gestionar spans.
Mezclarla con la API de trazado de Sentry dará como resultado spans anidados de forma incorrecta.

Para comenzar a usar la integración de OpenTelemetry del SDK de Rust de Sentry, agrega las dependencias necesarias a tu `Cargo.toml`:

```toml {filename:Cargo.toml}
[dependencies]
sentry = "{{@inject packages.version('sentry.rust') }}"
opentelemetry = { version = "0.29.1", features = ["trace"] }
opentelemetry_sdk = { version = "0.29.0", features = ["trace"] }
```

Inicializa el SDK y luego crea y registra `SentryPropagator` y `SentrySpanProcessor`:

```rust
use opentelemetry::{
    global,
    trace::{TraceContextExt, Tracer},
    KeyValue,
};
use opentelemetry_sdk::trace::SdkTracerProvider;
use sentry::integrations::opentelemetry as sentry_opentelemetry;

// Inicializa el SDK de Sentry
let _guard = sentry::init((
    "___PUBLIC_DSN___",
    sentry::ClientOptions {
        release: sentry::release_name!(),
        // Habilita la captura de trazas; establece un valor más bajo en producción.
        traces_sample_rate: 1.0,
        ..sentry::ClientOptions::default()
    },
));

// Registra el propagador de Sentry para el trazado distribuido
global::set_text_map_propagator(sentry_opentelemetry::SentryPropagator::new());

let tracer_provider = SdkTracerProvider::builder()
    // Registra el procesador de spans de Sentry para enviar spans de OpenTelemetry a Sentry
    .with_span_processor(sentry_opentelemetry::SentrySpanProcessor::new())
    .build();

global::set_tracer_provider(tracer_provider);
```

Usa la API de OpenTelemetry para crear spans. Sentry los capturará:

```rust
let tracer = global::tracer("tracer");
// Crea un span de Sentry (transacción) con el nombre "example"
tracer.in_span("example", |_| {
    // Crea un span hijo de Sentry con el nombre "child"
    tracer.in_span("child", |cx| {
        // Los atributos de los spans de OTEL se capturan como atributos de datos en el span de Sentry
        cx.span().set_attribute(KeyValue::new("my", "attribute"));

        // Captura un mensaje de error de Sentry y lo asocia con el span hijo en curso
        sentry::capture_message("¡Todo está en llamas!", sentry::Level::Error);
    });
});
```

<div id="http-instrumentation">
  ## Instrumentación HTTP
</div>

El SDK de Sentry ofrece una integración para el ecosistema `tower` que puede continuar automáticamente un trazo a partir de una solicitud HTTP entrante.

Al combinar ambas capas, el orden importa. Por ejemplo, con tower::ServiceBuilder, debes definir la capa Hub antes que la de Http, así:

```rust
use sentry_tower::{NewSentryLayer, SentryHttpLayer};
use tower::ServiceBuilder;

let layer = ServiceBuilder::new()
    .layer(NewSentryLayer::new_from_top())
    .layer(SentryHttpLayer::with_transaction());
```
