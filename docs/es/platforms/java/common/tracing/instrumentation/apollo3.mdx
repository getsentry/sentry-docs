---
title: Integración con Apollo 3
sidebar_order: 31
sdk: sentry.java.apollo-3
description: "Aprende a capturar información de trazado del cliente Apollo GraphQL."
notSupported:
  - java.logback
  - java.log4j2
  - java.jul
---

<Alert>
  Para poder capturar transacciones, primero debes <PlatformLink to="/tracing/">configurar el trazado</PlatformLink>.
</Alert>

La integración de Apollo 3 de Sentry proporciona `SentryApollo3Interceptor` y `SentryApollo3HttpInterceptor`, que crean un span por cada solicitud HTTP saliente ejecutada con un cliente GraphQL de [Apollo Kotlin](https://github.com/apollographql/apollo-kotlin). La integración también proporciona funciones de extensión en `ApolloClient.Builder`.

<Alert>
  Esta integración es compatible con Apollo 3.x. Para Apollo 4.x, usa nuestra <PlatformLink to="/tracing/instrumentation/apollo4">integración con Apollo 4</PlatformLink>.
</Alert>

<div id="install">
  ## Instalación
</div>

Instala la integración de Apollo 3:

```xml {tabTitle:Maven}
<dependency>
    <groupId>io.sentry</groupId>
    <artifactId>sentry-apollo-3</artifactId>
    <version>{{@inject packages.version('sentry.java.apollo-3', '5.2.0') }}</version>
</dependency>
```

```groovy {tabTitle:Gradle}
implementation 'io.sentry:sentry-apollo-3:{{@inject packages.version('sentry.java.apollo-3', '5.2.0') }}'
```

```scala {tabTitle: SBT}
libraryDependencies += "io.sentry" % "sentry-apollo-3" % "{{@inject packages.version('sentry.java.apollo-3', '5.2.0') }}"
```

Para otros gestores de dependencias, consulta el [repositorio central de Maven](https://search.maven.org/artifact/io.sentry/sentry-apollo-3).

<div id="configure-with-extension">
  ## Configurar con la extensión
</div>

Agrega `Interceptors` a `ApolloClient.Builder` usando `SentryApolloBuilderExtensions`:

```java
import com.apollographql.apollo3.ApolloClient;
import io.sentry.apollo3.SentryApolloBuilderExtensionsKt;

ApolloClient apollo = SentryApolloBuilderExtensionsKt.sentryTracing(new ApolloClient.Builder())
    .serverUrl("https://tu-host-de-api/")
    .build();
```

```kotlin
import com.apollographql.apollo3.ApolloClient
import io.sentry.apollo3.sentryTracing

val apollo = ApolloClient.builder()
    .serverUrl("https://your-api-host/")
    .sentryTracing()
    .build()
```

<div id="manual-configuration">
  ## Configuración manual
</div>

Dado que los `HttpInterceptors` deben agregarse al `NetworkTransport`, los `SentryInterceptors` tienen que añadirse manualmente si estás usando un `NetworkTransport` personalizado:

```java
import com.apollographql.apollo3.ApolloClient;
import com.apollographql.apollo3.network.http.HttpNetworkTransport;
import io.sentry.apollo3.SentryApollo3HttpInterceptor;
import io.sentry.apollo3.SentryApollo3Interceptor;

ApolloClient apollo = new ApolloClient.Builder()
        .networkTransport(
            new HttpNetworkTransport.Builder()
                .serverUrl("https://tu-host-de-api/")
                .addInterceptor(new SentryApollo3HttpInterceptor())
                .build())
        .addInterceptor(new SentryApollo3Interceptor())
        .build();
```

```kotlin
import com.apollographql.apollo3.ApolloClient
import io.sentry.apollo3.SentryApollo3HttpInterceptor
import io.sentry.apollo3.SentryApollo3Interceptor
import com.apollographql.apollo3.network.http.HttpNetworkTransport

val apollo = ApolloClient.builder()
    .networkTransport(
        HttpNetworkTransport.Builder()
            .serverUrl("https://apollo-fullstack-tutorial.herokuapp.com/graphql")
            .addInterceptor(SentryApollo3HttpInterceptor())
            .build()
    )
    .addInterceptor(SentryApollo3Interceptor())
    .build()
```

<Alert title="Importante">
  Apollo Kotlin está desarrollado con coroutines de Kotlin. Esto significa que `SentryApolloInterceptor` puede usarse con Java únicamente en el modo Global Hub (un solo Hub utilizado por todos los hilos), con Kotlin usando el modo de Hub único, o con la <PlatformLink to="/enriching-events/scopes/#kotlin-coroutines">compatibilidad de Sentry con coroutines</PlatformLink>.
</Alert>

<div id="using-with-java">
  ## Uso con Java
</div>

Configurar el modo de Global Hub:

```java
import io.sentry.Sentry;

Sentry.init(options -> {
  ..
}, true)
```

<Alert>
  En el modo Global Hub, todos los hilos usan el mismo Hub.
</Alert>

<div id="using-with-kotlin-coroutines">
  ## Uso con Kotlin Coroutines
</div>

Asegúrate de que tu coroutine tenga acceso al contexto correcto de Sentry al iniciarla, proporcionando una instancia de `SentryContext`:

```kotlin
import com.apollographql.apollo3.ApolloClient
import com.apollographql.apollo3.exception.ApolloException
import io.sentry.kotlin.SentryContext
import kotlinx.coroutines.launch

launch(SentryContext()) {
  val response = try {
    apollo.query(..).toDeferred().await()
  } catch (e: ApolloException) {
    // gestionar errores de protocolo
    return@launch
  }
}
```

<div id="modify-or-drop-spans">
  ## Modificar o descartar spans
</div>

Los spans creados en torno a las solicitudes pueden modificarse o descartarse usando `SentryApollo3HttpInterceptor.BeforeSpanCallback`, que se pasa a `SentryApollo3HttpInterceptor`, o la función de extensión `sentryTracing`:

```java
import com.apollographql.apollo3.ApolloClient;
import io.sentry.apollo3.SentryApolloBuilderExtensionsKt;

ApolloClient apollo = SentryApolloBuilderExtensionsKt.sentryTracing(
            new ApolloClient.Builder(),
            (span, request, response) -> {
              if ("LaunchDetails".equals(span.getOperation())) {
                span.setTag("tag-name", "tag-value");
              }
              return span;
            })
        .serverUrl("https://tu-host-de-la-api/")
        .build();
```

```kotlin
import com.apollographql.apollo3.ApolloClient
import io.sentry.apollo3.sentryTracing

val apollo = ApolloClient.builder()
    .serverUrl("https://apollo-fullstack-tutorial.herokuapp.com/graphql")
    .sentryTracing { span, request, response ->
        if ("LaunchDetails" == span.operation) {
            span.setTag("tag-name", "tag-value")
        }
        span
    }
    .build()
```

<div id="graphql-client-errors">
  ## Errores del cliente GraphQL
</div>

Esta característica captura automáticamente los errores del cliente GraphQL (como operaciones incorrectas y códigos de respuesta) como eventos de error y los envía a Sentry. El evento de error incluirá los datos de `request` y `response`, como la `url`, el `status_code` y `data` (el `query` serializado).

Sentry agrupará los errores del cliente GraphQL por `operationName`, `operationType` y `statusCode`, para que puedas ver fácilmente cuántos errores hubo en cada caso.

Esta característica está habilitada de forma predeterminada y puede desactivarse estableciendo la opción `captureFailedRequests` en `false`:

```kotlin
import com.apollographql.apollo3.ApolloClient
import io.sentry.apollo3.sentryTracing

val apollo = ApolloClient.builder()
    .serverUrl("https://tu-servidor-de-api/")
    .sentryTracing(captureFailedRequests = false)
    .build()
```

De forma predeterminada, solo se capturarán como eventos de error los errores del cliente de GraphQL cuya respuesta incluya el array [errors](https://spec.graphql.org/October2021/#sec-Errors).

Los errores del cliente de GraphQL de cualquier destino (expresión regular `.*`) se capturan automáticamente, pero puedes cambiar este comportamiento configurando la opción `failedRequestTargets` con una expresión regular o una cadena de texto simple. Una cadena simple debe contener al menos uno de los elementos de la lista. Las cadenas simples no tienen que ser coincidencias exactas; es decir, la URL de una solicitud se considera coincidente cuando contiene una cadena proporcionada mediante la opción.

```kotlin
import com.apollographql.apollo3.ApolloClient
import io.sentry.apollo3.sentryTracing

val apollo = ApolloClient.builder()
    .serverUrl("https://tu-host-de-api/")
    .sentryTracing(captureFailedRequests = true, failedRequestTargets = listOf("myapi.com"))
    .build()
```

De forma predeterminada, los eventos de error no incluirán `Headers` ni `Cookies`, pero puedes cambiar este comportamiento estableciendo la opción `sendDefaultPii` en `true`:

```kotlin
Sentry.init { options ->
  options.isSendDefaultPii = true
}
```

Los eventos de error contendrán los cuerpos sin procesar de las solicitudes y respuestas GraphQL, que pueden incluir datos sensibles. Para evitarlo, parametriza tus consultas usando el campo [variables](https://spec.graphql.org/October2021/#sec-Language.Variables). Luego, [Relay](/es/product/relay) aplicará [PII Data Scrubbing](/es/product/relay/#pii-data-scrubbing), transformando automáticamente los valores en “[Filtered]”.

Como alternativa, puedes personalizar el evento y limpiar los datos por tu cuenta.

<div id="customize-or-drop-the-error-event">
  ### Personaliza o descarta el evento de error
</div>

El evento de error capturado puede personalizarse o descartarse con un `BeforeSendCallback`:

```kotlin
import io.sentry.Sentry
import io.sentry.SentryOptions.BeforeSendCallback
import com.apollographql.apollo3.api.http.HttpRequest
import com.apollographql.apollo3.api.http.HttpResponse
import io.sentry.TypeCheckHint.APOLLO_REQUEST
import io.sentry.TypeCheckHint.APOLLO_RESPONSE

Sentry.init { options ->
  // Agrega un callback que se usará antes de enviar el evento a Sentry.
  // Con este callback puedes modificar el evento o, si devuelves null, descartarlo.
  options.beforeSend = BeforeSendCallback { event, hint ->
    val request = hint.getAs(APOLLO_REQUEST, HttpRequest::class.java)
    val response = hint.getAs(APOLLO_RESPONSE, HttpResponse::class.java)

    // personaliza o descarta el evento
    event
  }
}
```
