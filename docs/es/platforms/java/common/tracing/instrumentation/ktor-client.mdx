---
title: Integración de Ktor Client
sidebar_order: 45
sdk: sentry.java.ktor-client
description: "Aprende a capturar información de trazado al usar Ktor Client."
notSupported:
  - java.logback
  - java.log4j2
  - java.jul
---

<Alert>
  Para capturar transacciones, primero debes <PlatformLink to="/tracing/">configurar el trazado</PlatformLink>.
</Alert>

La biblioteca `sentry-ktor-client` ofrece compatibilidad con [Ktor Client](https://ktor.io/) para Sentry mediante el complemento Sentry Ktor Client.

En esta página te ayudamos a empezar con la integración de Ktor Client de Sentry.
La integración permite:

* Añadir breadcrumbs para cada solicitud HTTP.
* Capturar spans para cada solicitud HTTP, con soporte de trazado distribuido. El span se creará como hijo del span actual vinculado al scope (si lo hay).
* Capturar ciertos fallos de solicitud como errores en Sentry.

La integración de Sentry Ktor Client es compatible con la versión `3.x` de Ktor Client.

<Alert level="warning">
  Si usas Ktor Client con OKHttp como motor y ya utilizas la [integración de Sentry para OkHttp](/es/platforms/java/tracing/instrumentation/okhttp/),
  evita usar esta integración; de lo contrario, el SDK generará datos duplicados e instrumentará cada solicitud HTTP dos veces.
  Usa en su lugar la [integración de Sentry para OkHttp](/es/platforms/java/tracing/instrumentation/okhttp/), ya que ofrece información más detallada sobre las solicitudes HTTP.
</Alert>

<div id="install">
  ## Instalación
</div>

Para instalar la integración:

```groovy {tabTitle:Gradle}
implementation 'io.sentry:sentry-ktor-client:{{@inject packages.version('sentry.java.ktor-client', '8.18.0') }}'
```

<div id="configure">
  ## Configuración
</div>

Crea el cliente HTTP de Ktor con el motor que prefieras e instala el plugin Sentry Ktor Client:

```kotlin
import io.ktor.client.*
import io.ktor.client.engine.java.*
import io.sentry.ktorClient.SentryKtorClientPlugin

val ktorClient = HttpClient(Java) {
    install(SentryKtorClientPlugin)
}
```

<div id="verify">
  ## Verificar
</div>

Este fragmento incluye una solicitud HTTP y captura un mensaje intencional para que puedas comprobar que todo funciona en cuanto lo configures:

```kotlin
import io.ktor.client.*
import io.ktor.client.engine.java.*
import io.ktor.client.request.*
import io.ktor.client.statement.*
import io.sentry.ktorClient.SentryKtorClientPlugin
import io.sentry.Sentry

suspend fun run(url: String): String? {
  val ktorClient = HttpClient(Java) {
    install(SentryKtorClientPlugin)
  }

  val response = ktorClient.get(url)
  val bodyStr = response.bodyAsText()

  Sentry.captureMessage("El mensaje $bodyStr")

  return bodyStr
}
```

Para ver y resolver el mensaje registrado, inicia sesión en [sentry.io](https://sentry.io) y abre tu proyecto. Al hacer clic en el título del error, se abrirá una página donde podrás ver información detallada y marcarlo como resuelto.

<div id="customize-the-recorded-span">
  ## Personaliza el span registrado
</div>

El span capturado se puede personalizar o descartar con un `BeforeSpanCallback`:

```kotlin
import io.ktor.client.*
import io.ktor.client.engine.java.*
import io.ktor.client.request.*
import io.ktor.http.*
import io.sentry.ISpan
import io.sentry.ktorClient.SentryKtorClientPlugin

val ktorClient = HttpClient(Java) {
  install(SentryKtorClientPlugin) {
    beforeSpan = { span, request ->
      // Descartar spans para solicitudes de admin
      if (request.url.toString().contains("/admin")) {
        null
      } else {
        span
      }
    }
  }
}
```

<div id="http-client-errors">
  ## Errores del cliente HTTP
</div>

Esta función captura automáticamente los errores del cliente HTTP (como códigos de respuesta no válidos) como eventos de error y los envía a Sentry. El evento de error incluirá los datos de `request` y `response`, como `url`, `status_code`, etc.

La captura de errores del cliente HTTP está habilitada de forma predeterminada. El SDK captura errores del cliente HTTP con códigos de respuesta entre `500` y `599`, pero puedes cambiar este comportamiento configurando el plugin:

```kotlin
import io.ktor.client.*
import io.ktor.client.engine.java.*
import io.sentry.HttpStatusCodeRange
import io.sentry.ktorClient.SentryKtorClientPlugin

val ktorClient = HttpClient(Java) {
  install(SentryKtorClientPlugin) {
    captureFailedRequests = true
    failedRequestStatusCodes = listOf(HttpStatusCodeRange(400, 599))
  }
}
```

Se capturan automáticamente los errores del cliente HTTP de todos los destinos (expresión regular `.*`), pero puedes cambiar este comportamiento configurando la opción `failedRequestTargets` con una expresión regular o con una cadena (`String`) simple. Una cadena simple debe contener al menos uno de los elementos de la lista. Las cadenas simples no tienen que coincidir por completo; es decir, la URL de una solicitud se considera coincidente cuando contiene una cadena proporcionada mediante la opción.

```kotlin
import io.ktor.client.*
import io.ktor.client.engine.java.*
import io.sentry.ktorClient.SentryKtorClientPlugin

val ktorClient = HttpClient(Java) {
  install(SentryKtorClientPlugin) {
    captureFailedRequests = true
    failedRequestTargets = listOf("myapi.com")
  }
}
```

De forma predeterminada, los eventos de error no incluirán ningún dato de PII, como `Headers` y `Cookies`. Puedes cambiar este comportamiento estableciendo la opción `sendDefaultPii` en `true`:

```kotlin
Sentry.init { options ->
  options.isSendDefaultPii = true
}
```

Esos eventos se pueden buscar y puedes configurar alertas para ellos si usas las propiedades `http.url` y `http.status_code`. Obtén más información en nuestra documentación completa sobre [Propiedades buscables](/es/concepts/search/searchable-properties/).

<div id="customize-or-drop-the-error-event">
  ### Personaliza o descarta el evento de error
</div>

El evento de error capturado puede personalizarse o descartarse con un `BeforeSendCallback`:

```kotlin
import io.sentry.Sentry
import io.sentry.SentryOptions.BeforeSendCallback
import io.sentry.TypeCheckHint.KTOR_CLIENT_REQUEST
import io.sentry.TypeCheckHint.KTOR_CLIENT_RESPONSE
import io.ktor.client.request.*
import io.ktor.client.statement.*

Sentry.init { options ->
  // Agrega un callback que se utilizará antes de enviar el evento a Sentry.
  // Con este callback, puedes modificar el evento o descartarlo devolviendo null.
  options.beforeSend = BeforeSendCallback { event, hint ->
    val request = hint.getAs(KTOR_CLIENT_REQUEST, HttpRequest::class.java)
    val response = hint.getAs(KTOR_CLIENT_RESPONSE, HttpResponse::class.java)

    // personaliza o descarta el evento
    event
  }
}
```
