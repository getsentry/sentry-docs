---
title: Oban
description: "Sentry admite la supervisión de trabajos programados de Oban y la captura automática de excepciones."
sidebar_order: 20
---

La integración de [Oban](https://getoban.pro) permite:

* Capturar errores y excepciones que ocurren en trabajos de Oban.
  * Supervisión de cron para trabajos programados de Oban.

Esta integración viene integrada en el SDK de Sentry a partir de la *v10.2.0*. Admite supervisión automática desde la *v10.3.0*. Requiere:

1. Oban versión 2.17.6 en adelante como dependencia de tu aplicación.
  1. Elixir versión 1.13 en adelante (requisito de Oban).

<div id="configure">
  ## Configurar
</div>

Puedes configurar la integración de Oban en la configuración de Sentry, en la clave `:integrations`:

```elixir {filename:config/config.exs} {diff}
config :sentry,
  # ...,
  integrations: [
+    oban: [
+      # Capturar errores:
+      capture_errors: true,
+      # Monitorear trabajos cron:
+      cron: [enabled: true]
+    ]
  ]
```

Esta configuración informará a Sentry los trabajos de Oban que fallen. También informará los trabajos iniciados, completados y fallidos, así como su duración. Usará el nombre del worker como `monitor_slug` del cron informado.

<Alert title="Errores en la ejecución">
  Oban envuelve los bloqueos, salidas y lanzamientos *no controlados* de los trabajos en excepciones [`Oban.CrashError`](https://hexdocs.pm/oban/2.18.0/Oban.CrashError.html). Sin embargo, si los trabajos devuelven errores manualmente (por ejemplo, devolviendo tuplas `{:error, reason}`), entonces Oban los envolverá en excepciones [`Oban.PerformError`](https://hexdocs.pm/oban/2.18.0/Oban.PerformError.html). Si solo quieres informar bloqueos a Sentry, puedes configurar un filtro de eventos que no informe eventos `Oban.PerformError`, o que inspeccione su campo `:reason` para decidir si informarlos. Por ejemplo:

  ```elixir
  def before_send(event) do
    case event.original_exception do
      %Oban.PerformError{reason: {:error, reason}} -> event
      %Oban.PerformError{} -> nil
      _other -> event
    end
  end
  ```

  El propio trabajo de Oban (una estructura [`Oban.Job`](https://hexdocs.pm/oban/Oban.Job.html)) también está disponible dentro del campo `:integration_meta` del evento, en:

  ```elixir
  event.integration_meta[:oban][:job]
  ```

  Puedes usar esto para una lógica de filtrado más compleja basada en el número de intentos y similares.

  Consulta <Link to="/platforms/elixir/configuration/filtering">la documentación sobre callbacks de eventos</Link>.
</Alert>


<div id="customizing-job-check-in-information">
  ### Personalizar la información de check-in de un job
</div>

Si quieres personalizar la información que se envía a Sentry cuando un job hace check-in, puedes hacerlo proporcionando una función que reciba el job y devuelva un mapa de metadatos.

```elixir {filename:lib/my_app/my_worker.ex}
defmodule MyApp.MyWorker do
  use Oban.Worker

  @behaviour Sentry.Integrations.Oban.Cron

  @impl Oban.Worker
  def perform(args) do
    # ...
  end

  @impl Sentry.Integrations.Oban.Cron
  def sentry_check_in_configuration(job) do
    [monitor_slug: "custom-slug-#{job.id}"]
  end
end
```

Esto está disponible desde la v10.9.0 del SDK.
