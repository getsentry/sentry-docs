---
title: Decodificación de imágenes en el hilo principal
sidebar_order: 30
description: >-
  Obtén más información sobre los problemas de decodificación de imágenes en el hilo principal y cómo diagnosticarlos y solucionarlos.
og_image: >-
  /og-images/product-issues-issue-details-performance-issues-image-decoding-main-thread.png
---

El hilo principal (o de la interfaz) en una app móvil se encarga de toda la interacción con el usuario y debe poder responder a gestos y toques en tiempo real. Si una operación prolongada bloquea el hilo principal, la app deja de responder, lo que afecta la calidad de la experiencia del usuario.

El proceso de decodificar una imagen JPEG o PNG comprimida en un mapa de bits (especialmente en el caso de imágenes grandes) es un ejemplo de operación prolongada que puede afectar la capacidad de respuesta de la app. Si se detecta una decodificación de imágenes de larga duración en el hilo principal, Sentry la marcará como un problema.

<div id="detection-criteria">
  ## Criterios de detección
</div>

[Profiling](/es/product/explore/profiling/) debe estar habilitado para que Sentry detecte problemas de Decoding on Main Thread. Sentry busca funciones relacionadas con la decodificación de imágenes que se hayan estado ejecutando en el hilo principal durante al menos 40 ms. Este umbral garantiza que la función aparezca en un número suficiente de muestras recopiladas por el perfil (~10 ms por muestra x 4 = ~40 ms en total) antes de que se detecte como un problema.

<div id="function-evidence">
  ## Evidencia de la función
</div>

Para encontrar información adicional sobre tu problema de Image Decoding on Main Thread, ve a la página de **Issue Details** y desplázate hasta la sección &quot;Function Evidence&quot;, que muestra lo siguiente:

* **Transaction Name:** El nombre de la transacción en la que se detectó el problema.
* **Suspect function:** La función que activó la detección del problema (en este caso, una función de decodificación de imágenes).
* **Duration:** El tiempo que tardó la función en ejecutarse y la cantidad de muestras consecutivas recopiladas por el profiler que incluían la función.

![Image Decoding on Main Thread Function Evidence](./img/image-decoding-function-evidence.png)

Para ver el perfil completo asociado con el problema, haz clic en el botón &quot;View Profile&quot;.

El perfil indicará desde dónde se llamó a la función sospechosa, junto con otras funciones llamadas *por* la función sospechosa:

![Image Decoding on Main Thread Profile](./img/image-decoding-profile.png)

<div id="stack-trace">
  ## Trazado de pila
</div>

La sección “Trazado de pila” muestra un trazado de pila completo que indica desde dónde se llamó a la función detectada de decodificación de imágenes:

![Trazado de pila de decodificación de imágenes en el hilo principal](./img/image-decoding-stack-trace.png)

<div id="example">
  ## Ejemplo
</div>

<div id="ios">
  ### iOS
</div>

El siguiente código muestra una imagen asignando la propiedad `image` de `UIImageView`. La imagen no se decodifica al llamar a `UIImage.init(data:)`, sino cuando se muestra en pantalla, lo cual ocurre en el hilo principal.

```swift
func mostrarImagen(datos: Data) {
	imageView.image = UIImage(data: datos)
}
```

El rendimiento puede mejorar si se usa `[UIImage.preparingForDisplay()](https://developer.apple.com/documentation/uikit/uiimage/3750834-preparingfordisplay)` para preparar la imagen para su visualización en una cola en segundo plano, antes de asignarla a la image view en la cola principal:

```swift
func mostrarImagen(datos: Data) {
	DispatchQueue.global(qos: .userInitiated).async {
		let imagen = UIImage(data: datos)?.preparingForDisplay()
		DispatchQueue.main.async {
			imageView.image = imagen
		}
	}
}
```

<div id="android">
  ### Android
</div>

El siguiente código invoca `BitmapFactory.decodeByteArray` en el hilo de la interfaz de usuario para decodificar una imagen y mostrarla en un `ImageView`:

```kotlin
fun showImage(data: ByteArray) {
	imageView.setImageBitmap(BitmapFactory.decodeByteArray(data, 0, data.size))
}
```

Se podría mejorar el rendimiento moviendo la decodificación de la imagen a una corrutina:

```kotlin
fun showImage(data: ByteArray) {
	lifecycleScope.launch(Dispatchers.IO) {
	  val bitmap = BitmapFactory.decodeByteArray(data, 0, data.size)

    withContext(Dispatchers.Main) {
      imageView.setImageBitmap(bitmap)
    }
  }
}
```
