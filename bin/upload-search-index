
#!/bin/bash
# usage: bin/upload-search-index
#
# Uploads the contents of _site to rigidsearch

set -e

RIGIDSEARCH_SERVER=${RIGIDSEARCH_SERVER:-"http://127.0.0.1:5001/"}
RIGIDSEARCH_SECRET=${RIGIDSEARCH_SECRET:-"supersecretnotreallythough"}

if [ ! -d "_site" ]; then
  echo "‚ùå Sentry Docs has not been compiled. Please run bin/server"
  exit 1
fi

cd _site
mkdir -p ./tmp/
ZIP=../tmp/search-files.zip
if [ -f "$ZIP" ]; then rm -f $ZIP; fi

find . -name '*.html' | zip -@ -9 $ZIP
curl -i ${RIGIDSEARCH_SERVER}api/index/sources -XPUT -F archive=@$ZIP -F secret="${RIGIDSEARCH_SECRET}" -F config=@../config/search.json
