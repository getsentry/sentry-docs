#!/bin/bash
# usage: bin/server
#
# Run the jekyll server

set -e

green="\033[0;32m"
reset="\033[0;m"

echo -e "‚ùì  ${green}Would you like to run Sentry Docs in incremental build mode? [Y/n]${reset}"
read -t 7
REPLY=${REPLY:-y}

if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo "üëç  The first build will take a while, but the rest will be faster."
  echo ""
  incremental="--incremental "
else
  echo "üëç  Ok, running in normal build mode"
fi

if lsof -i :5001 > /dev/null 2>&1; then
  echo -e "‚ùì  ${green}Would you like to connect search to your local RigidSearch instance? [Y/n]${reset}"
  read -t 7
  REPLY=${REPLY:-y}

  if [[ $REPLY =~ ^[Yy]$ ]]; then
    export RIGIDSEARCH_SERVER="http://127.0.0.1:5001/"
    echo "üëç  Ok, I‚Äôll point search requests to $RIGIDSEARCH_SERVER"
  else
    echo "üëç  Ok, I'll pretend I don‚Äôt know you‚Äôre running that server"
  fi
fi

if [ -z ${RIGIDSEARCH_SERVER+x} ]; then
  export JEKYLL_SEARCH_DISABLED=True
fi

rm -rf _site
rm -rf .jekyll-cache

yarn
(bundle check || bundle install)

./bin/webpack-watch & ./bin/jekyll-watch
