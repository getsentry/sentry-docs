{% comment %}
Save the previous context so this loop doesn't clobber data from it's parent call
{% endcomment %}
{%- assign __CONTEXT_items_at_current_depth = __items_at_current_depth-%}
{%- assign __CONTEXT_group = __group -%}

<ul class="list-unstyled">
{%- for __item in include.data -%}
<li{% if include.is_category %} class="mb-2 mb-md-4"{% endif %}>
  {%- include sidebar/preserve_context.html -%}

  {%- assign __template_list = include.templates
    | split: ","
  -%}
  {%- assign __template_slug = __template_list
    | first
  -%}
  {%- assign __template_path = __template_slug
    | prepend: "sidebar/"
    | append: ".html"
  -%}

  {%- include {{ __template_path }}
    slug=__item.slug
    document=__item.document
    categories=include.categories
  -%}

  {%- if __item.items -%}
    {%- assign __new_template_list_length = __template_list.size
      | minus: 1
    -%}
    {%- if __new_template_list_length < 1 -%}
      {%- assign __new_template_list = __template_slug -%}
    {%- else -%}
      {%- assign __new_template_list = __template_list
        | slice: 1, __new_template_list_length
        | join: ','
      -%}
    {%- endif -%}

    {% include sidebar/tree.html
      data=__item.items
      templates=__new_template_list
    %}
  {%- endif -%}

  {%- include sidebar/restore_context.html -%}
</li>
{%- endfor -%}
</ul>

{% comment %}
Reset our variables so the state is clean for the next loop
{% endcomment %}
{%- assign __items_at_current_depth = __CONTEXT_items_at_current_depth-%}
{%- assign __group = __CONTEXT_group -%}
