{% comment %}

IMPORTANT

Jekyll does not scope variables. This is a recursive include, so any variable
that is assigned or captured must be manually scoped so that child includes do
not clobber parent values. Before assigning a variable, assign a variable with
the same name, prefixed with __scope_. Then at the end of the context, reassign
the original value for the variable with the scoped variable value.

{% endcomment %}

{%- if include.documents.size > 0 -%}

{%- assign __scope_group_by_exp = __group_by_exp -%}
{%- capture __group_by_exp -%}item.path | split: "/" | size{%- endcapture -%}

{%- assign __scope_grouped_by_segments = __grouped_by_segments -%}
{%- assign __grouped_by_segments = include.documents
  | sort: 'sidebar_order'
  | group_by_exp: 'item', __group_by_exp
-%}

{%- assign __scope_relative_segments = __relative_segments -%}
{%- assign __relative_segments = include.relative_to | split: '/' -%}

{%- assign __scope_current_depth = __current_depth -%}
{%- assign __current_depth = __relative_segments.size -%}

{%- assign __scope_documents_depth_for_this_level = __documents_depth_for_this_level-%}
{%- assign __documents_depth_for_this_level = __current_depth | plus: 2 -%}

{%- assign __scope_documents_for_this_level = __documents_for_this_level -%}
{%- assign __documents_for_this_level = __grouped_by_segments
  | where: 'name', __documents_depth_for_this_level
  | map: 'items'
  | first
-%}

{%- assign __scope_child_depth = __child_depth -%}
{%- assign __child_depth = __documents_depth_for_this_level | plus: 1 -%}

<ul>
  {%- for __document in __documents_for_this_level -%}
  <li>
    {%- include sidebar/document.html document=__document -%}

    {%- assign __scope_document_segments = __document_segments -%}
    {%- assign __document_segments = __document.path | split: "/" -%}

    {%- assign __scope_new_relative_path = __new_relative_path -%}
    {%- assign __new_relative_path = __document_segments | pop | join: '/' -%}

    {%- assign __scope_folder_matching_document_slug = __folder_matching_document_slug -%}
    {%- assign __folder_matching_document_slug = __document_segments
      | last
      | split: '.'
      | first
      | prepend: '/'
      | prepend: __new_relative_path
      | append: '/'
    -%}
    {%- assign __scope_where_exp = __where_exp -%}
    {%- capture __where_exp -%}item.path contains "{{ __folder_matching_document_slug }}"{%- endcapture -%}

    {%- assign __scope_children = __children -%}
    {%- assign __children = include.documents
      | where_exp: 'item', __where_exp
    -%}

    {%- include sidebar/tree.html
      documents=__children
      relative_to=__new_relative_path
    -%}

    {%- assign __document_segments = __scope_document_segments -%}
    {%- assign __new_relative_path = __scope_new_relative_path -%}
    {%- assign __folder_matching_document_slug = __scope_folder_matching_document_slug -%}
    {%- assign __where_exp = __scope_where_exp -%}
    {%- assign __children = __scope_children -%}
  </li>
  {%- endfor -%}
</ul>
{%- endif -%}

{%- assign __group_by_exp = __scope_group_by_exp -%}
{%- assign __grouped_by_segments = __scope_grouped_by_segments -%}
{%- assign __relative_segments = __scope_relative_segments -%}
{%- assign __current_depth = __scope_current_depth -%}
{%- assign __documents_depth_for_this_level = __scope_documents_depth_for_this_level -%}
{%- assign __documents_for_this_level = __scope_documents_for_this_level -%}
{%- assign __child_depth = __scope_child_depth -%}
