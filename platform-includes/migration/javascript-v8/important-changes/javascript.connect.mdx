### Supported versions

Sentry Node SDK `8.x` supports Node `14.18.0` or higher

If you need to support older versions of Node.js, please use Sentry Node SDK `7.x`.

### Updated SDK initialization

With 8.x, @sentry/node has been completely overhauled. It is now powered by [OpenTelemetry](https://opentelemetry.io/) under the hood. You do not need to know or understand what OpenTelemetry is in order to use Sentry. We set up OpenTelemetry under the hood, no knowledge of it is required in order to get started, though if you use OpenTelemetry-native APIs to start spans, and Sentry will pick up everything automatically.

Here's an example of instrumentating a Connect application with Sentry Node SDK `8.x`:

```javascript {tabTitle:CommonJS}
const connect = require('connect');
const Sentry = require('@sentry/node');
const app = connect();

// Add routes etc. here

Sentry.setupConnectErrorHandler(app);

app.listen(3000);
```

```javascript {tabTitle:ESM}
import connect from 'connect';
import * as Sentry from "@sentry/node";
const app = connect();

// Add your routes, etc. here

Sentry.setupConnectErrorHandler(app);

app.listen(3030);
```

To migrate your Connect app to Sentry Node SDK `8.x`, you need to make the following changes:

1. Create an external file called `instrument.js` and move your `Sentry.init` call to it.

Due to the way that auto instrumentation works in `8.x` of the Sentry Node SDK, it is required that you initialize Sentry before you require or import any other package. Any package that is required/imported before Sentry is initialized may not be correctly auto-instrumented.

```JavaScript {tabTitle:CommonJS} {filename: instrument.js}
const Sentry = require('@sentry/node');

Sentry.init({
  // ...
});
```

```JavaScript diff {tabTitle:ESM} {filename: instrument.mjs}
import * as Sentry from "@sentry/node";

Sentry.init({
  // ...
});
```

2. Remove any performance related integrations

All performance auto-instrumentation will be automatically enabled if the package is found. You do not need to add any integration yourself, and `autoDiscoverNodePerformanceMonitoringIntegrations()` has also been removed. This means you can remove all custom `requestHandler` and `tracingMiddleware` Sentry code.

We now support the following integrations out of the box with 0 configuration:

- `httpIntegration`: Automatically instruments Node http and https standard libraries
- `nativeNodeFetchIntegration`: Automatically instruments top level fetch and undici
- `koaIntegration`: Automatically instruments Koa
- `graphqlIntegration`: Automatically instruments GraphQL
- `mongoIntegration`: Automatically instruments MongoDB
- `mongooseIntegration`: Automatically instruments Mongoose
- `mysqlIntegration`: Automatically instruments MySQL
- `mysql2Integration`: Automatically instruments MySQL2
- `postgresIntegration`: Automatically instruments PostgreSQL
- `prismaIntegration`: Automatically instruments Prisma

3. Add Sentry error handler

Previously you had to use `Sentry.Handlers.requestHandler()`, `Sentry.Handlers.tracingHandler()`, and `Sentry.Handlers.errorHandler()` to add Sentry instrumentation to your Connect app. In `8.x`, you only need to use `Sentry.setupConnectErrorHandler(app)`, you can remove all other handlers.

```JavaScript diff {tabTitle:CommonJS}
 const connect = require('connect');
 const Sentry = require('@sentry/node');
 const app = connect();

-app.use(Sentry.Handlers.requestHandler());
-app.use(Sentry.Handlers.tracingHandler());

// add routes etc. here

-app.use(Sentry.Handlers.errorHandler());
+Sentry.setupConnectErrorHandler(app);

 app.listen(3000);
```

```JavaScript diff {tabTitle:ESM}
 import connect from 'connect';
 import * as Sentry from "@sentry/node";
 const app = connect();

-app.use(Sentry.Handlers.requestHandler());
-app.use(Sentry.Handlers.tracingHandler());

// add routes etc. here

-app.use(Sentry.Handlers.errorHandler());
+Sentry.setupConnectErrorHandler(app);

 app.listen(3000);
```

4. Add `--require` or `--import` to your Node.js call

Using [--require](https://nodejs.org/api/cli.html#-r---require-module) or [--import](https://nodejs.org/api/cli.html#--importmodule) is the easiest way to guarantee that Sentry is imported and initialized before any other modules in your application.

```bash
# If you are using CommonJS (CJS)
node --require ./instrument.js app.js

# If you are using ECMAScript Modules (ESM)
# Note: This is only available for Node v18.19.0 onwards.
node --import ./instrument.mjs app.mjs
```

<Alert level="warning" title="Alternative">

If you cannot run node with [--require](https://nodejs.org/api/cli.html#-r---require-module) or [--import](https://nodejs.org/api/cli.html#--importmodule), [add a top-level import of `instrument.js` in your application](/platforms/javascript/guides/connect/initialize-sentry/add-as-toplevel-import).

</Alert>

### Ensure Request Isolation

For any non-HTTP scenarios (e.g. websockets or a scheduled job), you'll have to manually ensure request isolation by wrapping the function with `Sentry.withIsolationScope()`. Previously we recommended you use `Sentry.runWithAsyncContext` for this but that has been removed in `8.x`.

```javascript {tabTitle:CommonJS}
const Sentry = require('@sentry/node');

function myScheduledJob() {
  return Sentry.withIsolationScope(async () => {
    await doSomething();
    await doSomethingElse();
    return { status: 'DONE' };
  });
}
```

```javascript {tabTitle:ESM}
import * as Sentry from "@sentry/node";

function myScheduledJob() {
  return Sentry.withIsolationScope(async () => {
    await doSomething();
    await doSomethingElse();
    return { status: 'DONE' };
  });
}
```

This way, anything happening inside of this function will be isolated, even if they run concurrently.
