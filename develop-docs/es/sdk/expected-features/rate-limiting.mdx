---
title: Limitación de velocidad
sidebar_order: 2
---

Los límites se comunican a los SDK mediante códigos de estado y encabezados de respuesta. Para las respuestas de limitación habituales, emitimos un código de estado [`429`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429) y especificamos el encabezado [`Retry-After`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Retry-After).

Además de `Retry-After`, Sentry (Relay) también incluye el encabezado de respuesta especial `X-Sentry-Rate-Limits`, que contiene una lista detallada de todos los límites que aplican por categoría de datos.

```
X-Sentry-Rate-Limits: <quota_limit>, <quota_limit>, ...
```

Cada *quota&#95;limit* tiene la forma `retry_after:categories:scope:reason_code:namespaces:...` con los siguientes parámetros:

* `retry_after`: Número de segundos (como entero o número de coma flotante) hasta que expire este límite de velocidad.
* `categories`: Lista separada por punto y coma de [categorías de datos](https://github.com/getsentry/relay/blob/master/relay-base-schema/src/data_category.rs#L91). **Si está vacía, este límite se aplica a todas las categorías**.
  Aunque estas categorías puedan parecerse a los [tipos de elementos de envelope](/es/sdk/data-model/envelope-items/), no son idénticas y presentan ligeras diferencias.
* `scope`: El alcance al que se aplica este límite. Puede ser ignorado por los SDK.
* `reason_code`: Un identificador único de la cuota que indica el motivo de la limitación de velocidad. Puede ser ignorado por los SDK.
* `namespaces`: Lista separada por punto y coma de identificadores de espacios de nombres de métricas. Solo estará presente si el límite de velocidad se aplica a la categoría de datos `metric_bucket`. Si no se especifica el espacio de nombres, el backoff se aplica a todas las métricas.
* En el futuro se podrán agregar más parámetros, y los SDK pueden ignorarlos (promesa de compatibilidad retroactiva).

El Header puede contener espacios que deben ignorarse. Relay solo emitirá espacios después de `,` para separar *quota&#95;limits*.

**Respuesta de ejemplo** (formateada para facilitar la lectura):

```python
HTTP/1.1 429 Demasiadas Solicitudes
Retry-After: 2700
X-Sentry-Rate-Limits:
  60:transaction:key,
  2700:default;error;security:organization
```

**Respuesta de ejemplo** (con lista de categorías vacía):

```python
HTTP/1.1 429 Demasiadas solicitudes
Retry-After: 2700
X-Sentry-Rate-Limits: 60::organization, 2700::organization
```

**Respuesta de ejemplo** (para compartimentos de métricas):

```python
HTTP/1.1 429 Demasiadas solicitudes
Retry-After: 2700
X-Sentry-Rate-Limits: 2700:metric_bucket:organization:quota_exceeded:custom
```

El Header `X-Sentry-Rate-Limits` puede aparecer en cualquier respuesta, independientemente del código de estado, incluso en respuestas `200`. Esto sirve para informar proactivamente a los SDK de que ciertos tipos de payload están deshabilitados antes de que los SDK intenten enviarlos.

<div id="rate-limit-enforcement">
  ## Aplicación de límites de tasa
</div>

Se espera que los SDK respeten las respuestas 429 y los límites de tasa comunicados por Sentry, deteniendo la transmisión de datos hasta que el límite haya expirado. Los eventos, transacciones, sesiones y/o cualquier otro tipo de carga útil admitida, según los límites comunicados, deben descartarse durante el período en que el límite de tasa esté vigente.

<div id="stage-1-parse-response-headers">
  ### Etapa 1: Analizar los encabezados de respuesta
</div>

Para detectar límites de tasa en una respuesta de Sentry, sigue estos pasos:

1. En cada respuesta, busca `X-Sentry-Rate-Limits`. Si está presente, analízalo y pasa inmediatamente a la Etapa 2.
2. En respuestas `429`, verifica `Retry-After`. Trátalo como `categories=[]` y pasa a la Etapa 2. También se permite hacerlo en otros códigos de estado, aunque no es obligatorio.
3. En respuestas `429` sin los encabezados anteriores, asume un límite de 60 s para todas las categorías y pasa a la Etapa 2. Consulta la [implementación en Java](https://github.com/getsentry/sentry-java/blob/b182c6e4353dacd145a529298aa6f1ee41928d9f/sentry/src/main/java/io/sentry/transport/RateLimiter.java#L261-L270) como referencia.
4. De lo contrario, Sentry no comunica límites de tasa.

<div id="stage-2-determine-rate-limits">
  ### Etapa 2: Determinar los límites de velocidad
</div>

Pautas sobre cómo los SDK deben determinar los límites de velocidad vigentes:

* Los límites de velocidad deben llevarse por cada DSN, lo que implica almacenar un mapa de límites en una instancia del transporte/cliente del SDK.
* Los SDK que solo admiten un tipo de payload pueden ignorar `X-Sentry-Rate-Limits` y usar el encabezado `Retry-After` para determinar el vencimiento del límite.
* Los SDK deben implementar y respetar límites para las categorías admitidas, por ejemplo `error` y `transaction`. Para cada categoría, deben mantener un límite independiente, y otro límite independiente para la categoría implícita &quot;all&quot;.
* Los SDK deben ignorar las dimensiones que no admiten o que no sean relevantes, por ejemplo `scope` y `reason_code`.
* Las categorías y scopes que sean desconocidos para el cliente deben ignorarse. El límite sigue aplicando a las categorías conocidas. Los clientes deben prever que se añadirán más en el futuro.
* En términos más generales, se deben ignorar las dimensiones desconocidas; es decir, todos los dos puntos adicionales y el texto a la derecha de la última dimensión analizada/interpretada.
* Los límites donde **todas** las categorías sean desconocidas deben ignorarse, ya que esos límites aplican a datos que el SDK no puede enviar. No apliques categorías desconocidas a una categoría predeterminada. Ten en cuenta que esto es distinto de los límites sin categoría, que implícitamente aplican a todas las categorías (piénsalo como una categoría especial).
* Conserva siempre el límite de velocidad máximo si varios límites hacen referencia a la misma categoría. Si un límite nuevo es más corto que uno ya almacenado, conserva el más largo.
* `X-Sentry-Rate-Limits` devuelto en respuestas `200 OK` debe tratarse igual que en respuestas 429. Sentry puede responder con `200 OK` independientemente de un límite de velocidad o puede informar proactivamente a un cliente sobre un límite no relacionado con la solicitud actual. Esto ocurre específicamente para las cuotas de rechazo total para evitar que los clientes envíen solicitudes.

<div id="definitions">
  ## Definiciones
</div>

Como se indicó anteriormente, los SDK pueden ignorar la dimensión `scope`. Estas definiciones están aquí como un suplemento para explicar de qué está compuesto el encabezado `X-Sentry-Rate-Limits`.

* **Categoría:** Clasifica el tipo de datos que se contabiliza. Se pueden agregar categorías arbitrarias siempre que puedan inferirse del evento o de los datos que se están ingiriendo.
  Aunque estas [categorías de datos](https://github.com/getsentry/relay/blob/master/relay-base-schema/src/data_category.rs#L91) puedan parecer similares a los [tipos de elementos del envelope](/es/sdk/data-model/envelope-items/), no son idénticas y presentan ligeras diferencias.
  * `default`: Eventos con un `event_type` no listado explícitamente a continuación.
  * `error`: Eventos de error.
  * `transaction`: Eventos de tipo transacción.
  * `monitor`: Check-ins de monitor.
  * `span`: Eventos de tipo span.
  * `log_item`: Eventos de log.
  * `security`: Eventos con `event_type` `csp`
  * `attachment`: Bytes de adjuntos almacenados (no se usa para la limitación de tasa)
  * `session`: Eventos de actualización de sesión
  * `profile`: Eventos de perfilado
  * `profile_chunk`: Fragmentos de Perfilado Continuo
  * `replay`: Reproducciones de sesión
  * `feedback`: Comentarios de usuario
  * `metric_bucket`: Sentry Metrics enviados mediante los elementos `statsd` o `metrics`. El componente `namespaces` de la *quota&#95;limit* define qué espacios de nombres se verán afectados.
  * `internal`: evento interno del sistema/Sentry[^internal]

* **Ámbito**: La unidad/modelo en Sentry para la que se aplican las cuotas.
  * `organization`
  * `project`
  * `key`

[^internal]: Nota especial sobre la categoría de datos interna: esta categoría existe pero se garantiza que no se emitirá, ya que no aplicamos límites de tasa a los elementos internos. Puede parecer extraño, pero el propósito es permitir que las implementaciones de envelope en los SDK asignen una categoría de datos a elementos internos como `client_report`. Los SDK pueden manejar `internal` como cualquier otra categoría de datos, pero pueden confiar en que los límites de tasa no se comunican explícitamente para estos. Dicho esto, la categoría especial *all* también se aplica a los tipos de eventos `internal`.