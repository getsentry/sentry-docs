---
title: Módulo de consultas
---

El SDK debe auto‑instrumentar todas las consultas a la base de datos, y cada consulta a la base de datos debe generar un span. Esto incluye consultas realizadas manualmente o mediante un ORM. El módulo de consultas es compatible con bases de datos SQL como PostgreSQL y MySQL, así como con MongoDB. No es compatible con otras bases de datos como Neo4j o ClickHouse. Aun así, el SDK debe instrumentar las consultas a la base de datos de la manera más completa y correcta posible para garantizar el comportamiento adecuado y la compatibilidad futura.

<div id="span-attributes">
  ## Atributos de span
</div>

| Atributo | Descripción | Notas |
|:--|:--|:--|
| `op` | Con el prefijo `"db"` (p. ej., `"db"`, `"db.query"`, `"db.sql.query"`) [^1] | Obligatorio |
| `description` | La consulta despersonalizada completa (p. ej., `SELECT * FROM users where id = ?`) | Obligatorio; consulta [Query Scrubbing](#query-scrubbing) para más detalles |
| `data` | Un mapa clave-valor de atributos del span (p. ej., `{"db.system": "postgresql", "db.name": "prod-2"}`) | Obligatorio para la experiencia completa. Consulta [Span Data](#span-data) para más detalles |

<div id="query-scrubbing">
  ### Limpieza de consultas
</div>

La descripción de la consulta debe limpiarse de cualquier valor proporcionado por el usuario.

p. ej., la consulta

```sql
SELECT * FROM users WHERE id = 17;
```

debería depurarse a:

```sql
SELECT * FROM users WHERE id = ?;
```

El parámetro `?` es un marcador de posición en la consulta. El SDK debe depurar todos los valores y reemplazarlos por un marcador de posición. Los marcadores de posición admitidos son `%s`, `?`, `:c0` (p. ej., `:c0`, `:c1`) y `$1` (p. ej., `$1`, `$2`).

Para MongoDB, la descripción debe contener JSON válido. Si se reemplazan valores por un marcador de posición, se debe usar la cadena `"?"`.

```json
{ "find": "documents", "filter": { "wordCount": { "$gte": "?" } } }
```

<div id="span-data">
  ### Datos de span
</div>

Para una compatibilidad total, cada span de base de datos debe tener un atributo `data`. `data` es, a su vez, un mapa de pares clave-valor. Consulta las [convenciones de datos de spans de base de datos](/es/sdk/performance/span-data-conventions/#database) para ver la lista completa de atributos que deberían tener los spans de base de datos. Recomendamos que el SDK proporcione *todos* esos atributos para cada span. Sin embargo, el requisito *mínimo* es que el SDK proporcione el atributo `db.system`.

<div id="mongodb-data">
  #### Datos de MongoDB
</div>

La compatibilidad con MongoDB requiere algunos atributos de datos adicionales. Además de que `db.system` tenga el valor `"mongodb"`, también se requieren los atributos `db.operation` y `db.collection.name` para incluir el comando y el nombre de la colección, respectivamente.

<div id="sql-instrumentation-example">
  ## Ejemplo de instrumentación de SQL
</div>

Considera un ORM hipotético de Python:

```python
from magicORM import ORM
from .models import User, Product

ORM.connect_postgres(host="127.0.0.1", port="7777", database="production")
return User.find(17).find_related(Product)
```

Imagina que ejecuta esta consulta SQL:

```sql
SELECT * FROM projects
WHERE projects_user = 17;
```

Esto debería dar como resultado el siguiente span:

```json
{
  "description": "SELECT * FROM projects WHERE projects_user = 17",
  "op": "db",
  "data": {
    "db.system": "postgresql",
    "db.operation": "SELECT",
    "db.name": "production",
    "server.address": "127.0.0.1",
    "server.port": "7777"
  }
}
```

[^1]: Sentry acepta algunas operaciones, pero el módulo Queries no las indexa. Esto incluye `db.sql.room`, `db.redis` y otras. ¡No intentes engañar al sistema proporcionando una operación de span incorrecta!
