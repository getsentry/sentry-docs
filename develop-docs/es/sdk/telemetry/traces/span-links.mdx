---
title: Enlaces de spans
og_image: /og-images/sdk-telemetry-traces-span-links.png
---

Los enlaces de spans asocian un span con uno o más spans. El caso de uso más importante de vincular trazas son las aplicaciones de frontend.
También puede ser útil en entornos con patrones productor/consumidor o en operaciones por lotes.
Al usar enlaces de spans, podemos mostrar el recorrido del usuario en nuestras vistas de trazas para facilitar la depuración de problemas, ya que los desarrolladores obtienen más contexto sobre lo que ocurrió antes de un problema específico.

Un enlace de span puede almacenar el contexto de (es decir, enlazar a) cualquier otro span. Cuando sea necesario, se puede agregar un tipo de enlace especial (consulta [Tipos de enlace](#link-types)).

Obtén más información sobre los enlaces de spans en la [RFC 141](https://github.com/getsentry/rfcs/blob/main/text/0141-linking-traces.md) o en la [documentación de OpenTelemetry](https://opentelemetry.io/docs/concepts/signals/traces/#span-links).

<div id="sdk-implementation-guideline">
  ## Guía de implementación del SDK
</div>

- Los vínculos se añaden a nivel de span, según lo definido y especificado por [OpenTelemetry](https://opentelemetry.io/docs/specs/otel/trace/api/#link).
- Además de vincular a IDs de span, un vínculo de span también contiene metadatos sobre el vínculo, recopilados mediante atributos.
- Los vínculos de span DEBEN vincular únicamente a otros spans. No admitimos vincular un span a un error u otros eventos de Sentry.
- Para los SDK que aún tengan APIs públicas relacionadas con transacciones, su interfaz Transaction y la(s) función(es) `startTransaction` correspondientes deberían admitir las mismas APIs.

<div id="type-definitions">
  ### Definiciones de tipos
</div>

Los SDK deben seguir la especificación de OpenTelemetry para la interfaz Link según lo defina la plataforma.
Los SDK que no son de OTel deberían tomar a OTel como referencia, dando lugar a la interfaz siguiente, o a una versión afín que se ajuste a la terminología y la filosofía del SDK correspondiente:

```ts {tabTitle:Types}
// see https://github.com/open-telemetry/opentelemetry-js/blob/main/api/src/trace/link.ts
// o la interfaz de la plataforma correspondiente
interface Link {
  // contiene el SpanContext del span al que se va a vincular
  context: SpanContext;
  // par clave-valor con valores primitivos
  attributes?: Attributes;
}


// see https://github.com/open-telemetry/opentelemetry-js/blob/main/api/src/trace/span_context.ts
// o la interfaz de la plataforma correspondiente
interface SpanContext {
  traceId: string,
  spanId: string,
  traceFlags: number,
}

type Attributes = Record<string, AttributeValues>
type AttributeValues = string | boolean | number | Array<string> | Array<boolean> | Array<number>
```


<div id="required-span-api">
  ### API de spans requerida
</div>

Lo ideal es agregar el enlace al iniciar un span. Se añade un atributo opcional `links` a las opciones de `startSpan`.
Los SDK que no ofrecen APIs centradas en spans, sino, p. ej., APIs de transacciones, deben asegurarse de que sus respectivas APIs `start...` (p. ej., `startTransaction`) también ofrezcan la posibilidad de añadir enlaces.

```ts {tabTitle:Span Options}
function startSpan(options: StartSpanOptions);

interface StartSpanOptions: {
  //... otras opciones (name, attributes, etc.)
  links?: Link[];
}
```

Además, los SDK deben exponer al menos un método `addLink` en su interfaz `Span` correspondiente. Para alinearse con OpenTelemetry, lo ideal es que también expongan `addLinks`:

```ts {tabTitle:Span API}
interface Span {
  // el valor de retorno puede variar según la plataforma
  addLink(link: Link): this;
  addLinks(links: Link[]): this;
}
```


<div id="envelope-item-payload">
  ## Carga útil del elemento del sobre
</div>

Los árboles de spans se serializan en sobres de eventos de transacción en todos los SDK de Sentry. Por lo tanto, el elemento del sobre debe admitir enlaces de spans
en su carga útil. Si la entrada `links` es un arreglo vacío, se puede omitir del sobre.

Los objetos `links` serializados siempre deben contener:

* `span_id: string` - ID del span al que enlazar
* `trace_id: string` - ID de la traza del span al que enlazar
* `sampled: boolean` - obligatorio si está disponible la decisión de muestreo del span al que enlazar (corresponde a `traceFlags` en el contexto de span de OTel convertido a `boolean`)
* `attributes:` - obligatorio si se agregaron atributos al enlace

Opcionalmente, el objeto de enlace serializado puede contener otros campos de OTel como `traceState`, `isRemote` o `droppedAttributesCount`, que simplemente se reenviarán, a menos que encontremos un caso de uso para ellos.

Los campos de OTel `spanId`, `traceId` y `traceFlags` deben excluirse de los objetos de enlaces en el sobre para evitar datos duplicados (p. ej., `trace_id` vs. `traceId`).

Si el span raíz (anteriormente conocido como transacción) tiene enlaces de spans, los enlaces se almacenan en el contexto de la traza.

```ts {tabTitle:Example Trace Context}
// elemento del sobre del evento
{
  type: "transaction";
  transaction: string;
  contexts: {
    trace: {
      span_id: string;
      parent_span_id: string;
      trace_id: string;
      // campo nuevo para enlaces:
      links?: Array<{
        "span_id": string,
        "trace_id": string,
        sampled?: boolean, // traceFlags de Otel convertidos a booleano
        attributes?: Record<string, AttributeValue>,
        // + potencialmente más campos 1:1 desde Otel; p. ej., (traceState, droppedAttributesCount, isRemote)
      }>
      // ...
    }
  }
  // ...
}
```

Los enlaces almacenados en spans secundarios se serializan en `spans[i].links`.

```ts {tabTitle:Example Span Link Data}
// elemento del sobre del evento
{
  type: "transaction";
  transaction: string;
  spans: Array<{
    span_id: string;
    parent_span_id: string;
    trace_id: string;
    // nuevo campo para enlaces:
    links?: Array<{
      "span_id": string,
      "trace_id": string,
      sampled?: boolean,
      attributes?: Record<string, AttributeValue>,
    }>
    // ...
  }>
  // ...
}
```


<div id="link-types">
  ## Tipos de enlaces
</div>

Los enlaces no requieren un significado ni un tipo especial, pero si es necesario (por ejemplo, para identificar enlaces especiales en el producto), establece el atributo `sentry.link.type` en el enlace para definir el tipo.
Se puede usar cualquier cadena, pero estos tipos tienen significados predefinidos:

| `sentry.link.type` | Uso                                                             | Implicaciones en la UI                                                                            |
|--------------------|------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| "previous_trace"   | Vincula, p. ej., un span de navegación con el span de carga de la página anterior. | Se usa para consultar trazas vinculadas. Muestra un Button para ir a la traza anterior vinculada en el explorador de trazas. |
| "next_trace"       | Vincula, p. ej., un span de carga de página con el siguiente span de navegación.   | Se usa para consultar trazas vinculadas. Muestra un Button para ir a la siguiente traza vinculada en el explorador de trazas.     |

<div id="previous_trace">
  ### `previous_trace`
</div>

Los rastreos de frontend se pueden vincular añadiendo enlaces de span entre spans raíz. Por ejemplo, un span de navegación incluye un enlace al span de carga de la página anterior.

El contexto del span dentro del objeto de enlace debe almacenarse en el mecanismo de almacenamiento que se prefiera (p. ej., en memoria o `sessionStorage` en el navegador).

Por lo tanto, al iniciar el span raíz:

- Comprueba si hay un contexto de span anterior almacenado. Si lo hay, añade el enlace de span con el atributo `'sentry.link.type': 'previous_trace'`
- Almacena el contexto del span raíz como el span raíz anterior en el mecanismo de almacenamiento que se prefiera (p. ej., en memoria o `sessionStorage` en el navegador)

Los SDK pueden implementar heurísticas sobre cuánto tiempo debe considerarse un contexto de span de un rastreo anterior (tiempo máximo) y almacenar los datos adicionales necesarios.

![](./span-links-previous-trace-100.png)

<div id="negatively-sampled-traces">
  #### Trazas muestreadas negativamente
</div>

En muchos casos, con tasas de muestreo bajas, no podremos proporcionar una cadena completa de enlaces de traza, debido a que algunas o muchas trazas se muestrearon negativamente.

- Las spans raíz muestreadas deberían seguir incluyendo un enlace a la span raíz anterior muestreada negativamente (`traceFlags` en `spanContext()` contienen la información de que la span raíz anterior fue muestreada negativamente).

Esto ayuda a nuestro producto a indicar que hubo una traza anterior, pero fue muestreada negativamente.

No enlazaremos a la traza muestreada positivamente anterior si hay una traza muestreada negativamente de por medio (ver Trazas 2-4 en el diagrama a continuación).
Además, no mostraremos cuántas trazas se muestrearon negativamente entre dos cadenas de trazas; solo que hubo al menos una de por medio (ver Trazas 5-8).

![](./span-links-previous-trace-negative-sample.png)

<div id="usage-example">
  ## Ejemplo de uso
</div>

Agregar enlaces de span debería ser posible tanto al iniciar el span como cuando se cuenta con una referencia al mismo.

En el siguiente ejemplo, al agregar enlaces de span, podemos vincular desde el último rastro de navegación hasta el rastro de carga inicial de la página.
Al pasar el atributo `'sentry.link.type': 'previous_trace'`, podemos identificar el enlace como un vínculo a un rastro anterior en Sentry y mostrar los spans en consecuencia.

```ts {tabTitle:TypeScript}
// Inicia la 1.ª traza
const pageloadSpan = startInactiveSpan(...)

// Inicia la 2.ª traza
const navigation1Span = startInactiveSpan({
  name: '/users',
  links: [{
    context: pageloadSpan.spanContext(),
    attributes: {
      'sentry.link.type': 'previous_trace'
    }
  }]
});

// Inicia la 3.ª traza
const navigation2Span = startSpan({name: '/users/:id'}, (span) => {
  span.addLink({
    context: navigation1Span.spanContext(),
    attributes: {
      'sentry.link.type': 'previous_trace'
    }
  })
})
```


<div id="ingestrelay">
  ## Ingest/Relay
</div>

Relay reenvía los enlaces de spans en el formato requerido para su posterior procesamiento y almacenamiento.
Es importante destacar que Relay no exige que se definan enlaces de spans. Son completamente opcionales.
Relay se encarga de pasar enlaces de spans tanto en el span raíz como en cualquier span hijo (consulta el [payload del elemento del envelope](#envelope-item-payload)).

El tipo y la estructura esperados del arreglo de enlaces y su contenido están [definidos en Relay](https://github.com/getsentry/relay/blob/master/relay-event-schema/src/protocol/span.rs#L753).