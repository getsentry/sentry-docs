---
title: Procesador por lotes
---

<Alert level="warning">
  游뚾 Este documento est치 en desarrollo.
</Alert>

<Alert>
  Este documento usa palabras clave como &quot;MUST&quot;, &quot;SHOULD&quot; y &quot;MAY&quot;, seg칰n lo definido en [RFC 2119](https://www.ietf.org/rfc/rfc2119.txt), para indicar niveles de exigencia.
</Alert>

El BatchProcessor agrupa spans y logs en un 칰nico sobre para reducir la cantidad de solicitudes HTTP. Cuando un SDK implementa transmisi칩n de spans o logs, DEBE usar un BatchProcessor, similar al [Batch Processor de OpenTelemetry](https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/batchprocessor/README.md). El BatchProcessor mantiene en memoria los logs y los spans finalizados y los agrupa en sobres. Usa una combinaci칩n de lotificaci칩n basada en tiempo y en tama침o. Al momento de escribir esto, el BatchProcessor solo maneja spans y logs, pero un SDK PUEDE usarlo para otros datos de telemetr칤a en el futuro.

<div id="specification">
  ## Especificaci칩n
</div>

Cada vez que el SDK finalice un span o capture un log, DEBE colocarlo en el BatchProcessor. El SDK NO DEBE colocar spans sin finalizar en el BatchProcessor.

El BatchProcessor DEBE iniciar un temporizador de 5 segundos cuando el SDK agregue el primer span o log. Cuando se agote el temporizador, el BatchProcessor DEBE enviar todos los spans o logs, sin importar cu치ntos elementos contenga. El SDK PUEDE elegir un valor diferente para el temporizador, pero NO DEBE superar los 30 segundos, ya que esto puede ocasionar problemas con el b칰fer de spans en el backend, que utiliza un intervalo de 60 segundos para determinar segmentos para spans. El BatchProcessor DEBER칈A iniciar un nuevo temporizador solo cuando tenga spans o logs para enviar, para evitar que el temporizador corra innecesariamente.

El BatchProcessor DEBE enviar todos los elementos inmediatamente cuando tenga spans o logs que superen 1 MiB de tama침o. El SDK PUEDE elegir un valor diferente para el tama침o m치ximo del lote, teniendo en cuenta los [tama침os m치ximos del envelope](/es/sdk/data-model/envelopes/#size-limits). El SDK DEBE calcular el tama침o de un span o un log para gestionar la huella de memoria del BatchProcessor. El SDK DEBE serializar el span o log y calcular el tama침o en funci칩n de los bytes de JSON serializado. Dado que la serializaci칩n es costosa, el BatchProcessor DEBER칈A llevar un registro de los spans y logs serializados y pasarlos al envelope para evitar serializarlos varias veces.

Cuando el BatchProcessor env칤e todos los spans o logs, DEBE reiniciar su temporizador y eliminar todos los spans y logs. El SDK DEBE aplicar filtrado y muestreo antes de agregar spans o logs al BatchProcessor. El SDK DEBE aplicar l칤mites de tasa a los spans y logs despu칠s de que salgan del BatchProcessor para enviar la mayor cantidad de datos posible, descartando datos lo m치s tarde posible.

El BatchProcessor DEBE enviar todos los spans y logs en memoria para evitar p칠rdida de datos en los siguientes escenarios:

1. Cuando el usuario llame a `SentrySDK.flush()`, el BatchProcessor DEBE enviar todos los datos en memoria.
2. Cuando el usuario llame a `SentrySDK.close()`, el BatchProcessor DEBE enviar todos los datos en memoria.
3. Cuando la aplicaci칩n se cierre de forma ordenada, el BatchProcessor DEBER칈A enviar todos los datos en memoria. Esto es principalmente relevante para SDKs m칩viles que ya est치n suscritos a estos hooks, como [applicationWillTerminate](https://developer.apple.com/documentation/uikit/uiapplicationdelegate/applicationwillterminate\(_:\)) en iOS.
4. Cuando la aplicaci칩n pase a segundo plano, el BatchProcessor DEBER칈A enviar todos los datos en memoria y detener el temporizador. Esto es principalmente relevante para SDKs m칩viles.
5. Estamos trabajando en un concepto para fallos y actualizaremos la especificaci칩n cuando tengamos m치s detalles.

La especificaci칩n detallada est치 escrita en la [sintaxis de Gherkin](https://cucumber.io/docs/gherkin/reference/). La especificaci칩n utiliza spans como ejemplo, pero lo mismo aplica a logs o a cualquier otro dato de telemetr칤a futuro.

```Gherkin
Scenario: No hay spans en el BatchProcessor, se a침ade 1 span
    Given no hay spans en el BatchProcessor
    When el SDK finaliza 1 span
    Then el SDK coloca este span en el BatchProcessor
    And inicia un temporizador de 5 segundos
    And no env칤a el span a Sentry

Scenario: Span a침adido antes de que venza el temporizador
    Given el span A en el BatchProcessor
    Given pasan 4.9 segundos
    When el SDK finaliza el span B
    Then el SDK a침ade el span B al BatchProcessor
    And no reinicia el temporizador
    And no env칤a los spans A y B del BatchProcessor a Sentry

Scenario: Vence el temporizador y no hay spans ni logs para enviar
    Given no hay spans en el BatchProcessor
    When vence el temporizador
    Then el BatchProcessor no hace nada
    And no inicia un nuevo temporizador

Scenario: Spans de tama침o 1 MiB - 1 byte a침adidos, vence el temporizador
    Given spans de tama침o 1 MiB - 1 byte en el BatchProcessor
    When vence el temporizador
    Then el SDK a침ade todos los spans a un envelope
    And los env칤a a Sentry
    And reinicia el temporizador
    And limpia el BatchProcessor

Scenario: Spans de tama침o 1 MiB - 1 byte a침adidos dentro de 4.9 segundos
    Given spans de tama침o 1 MiB - 1 byte en el BatchProcessor
    When el SDK finaliza otro span y lo coloca en el BatchProcessor
    Then el BatchProcessor coloca todos los spans en un 칰nico envelope
    And env칤a el envelope a Sentry
    And reinicia el temporizador
    And limpia el BatchProcessor

Scenario: Spans sin finalizar
    Given no hay ning칰n span en el BatchProcessor
    When el SDK inicia un span pero no lo finaliza
    Then el BatchProcessor est치 vac칤o

Scenario: Span filtrado
    Given no hay ning칰n span en el BatchProcessor
    When el SDK finaliza un span
    And el span se filtra
    Then el BatchProcessor est치 vac칤o

Scenario: Span no muestreado
    Given no hay ning칰n span en el BatchProcessor
    When el SDK finaliza un span
    And el span no est치 muestreado
    Then el BatchProcessor est치 vac칤o

Scenario: Se a침ade 1 span y la aplicaci칩n se bloquea
  Given 1 span en el SpansAggregator
  When el SDK detecta un bloqueo
  Then el SDK no hace nada con los elementos del BatchProcessor
  And pierde los spans del BatchProcessor

```
