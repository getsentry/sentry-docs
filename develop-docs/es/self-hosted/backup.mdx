---
title: Copia de seguridad y restauración en autohospedado
sidebar_title: Copia de seguridad y restauración
sidebar_order: 20
description: Aprende a hacer copias de seguridad y restaurar tus datos de Sentry en autohospedado usando varios métodos
---

<div id="partial-json-backup">
  ## Copia de seguridad parcial en JSON
</div>

Si necesitas una forma rápida de hacer copia de seguridad, ver, examinar y restaurar datos de tu instancia de Sentry y
no necesitas datos históricos de eventos, puedes usar cualquiera de los siguientes métodos:

- Una copia de seguridad personalizada y acotada mediante `./sentry-admin.sh` (en versiones autohospedadas >=23.11.1).
- Ejecutar los scripts de copia de seguridad y restauración incluidos en el directorio `self-hosted/scripts` (en
  versiones autohospedadas >=23.3.1).
- Ejecutar manualmente los comandos `export` e `import` en el contenedor Docker `web`.

Estos comandos deben ejecutarse desde tu directorio `self-hosted` y solo guardarán y cargarán datos de “bajo volumen”.

<div id="whats-included">
  ### ¿Qué incluye?
</div>

La copia de seguridad parcial en JSON es exactamente eso: parcial. Su objetivo es incluir datos de “bajo volumen”, como
usuarios, organizaciones y configuraciones del servidor, y excluir datos de “alto volumen”, como eventos,
incidencias o cualquier elemento que haga referencia a archivos externos.

En concreto, por lo general una copia de seguridad parcial en JSON incluye los siguientes datos:

- Configuración global (opciones, cuentas de administrador, claves y autorizaciones de la API, etc.).
- Aplicaciones de Sentry, service hooks e integraciones básicas.
- Usuarios, sus autenticadores, notificaciones y búsquedas recientes/guardadas.
- Organizaciones, sus miembros y sus configuraciones.
- Proyectos, sus miembros y sus configuraciones.
- Equipos, sus miembros y sus configuraciones.
- Reglas de alertas, incidentes y monitores.

<div id="backup">
  ### Respaldo
</div>

<div id="basic-usage">
  #### Uso básico
</div>

Según la versión de `self-hosted` que estés ejecutando, puedes realizar una copia de seguridad JSON sencilla de la siguiente manera:

```shell
# Si usas la versión autogestionada <= 23.3.0:
docker compose run -v $(pwd)/sentry:/sentry-data/backup  --rm -T -e SENTRY_LOG_LEVEL=CRITICAL web export /sentry-data/backup/backup.json

# Si usas la versión autogestionada >= 23.3.1:
./scripts/backup.sh

# Si usas la versión autogestionada >= 24.1.0:
./scripts/backup.sh [user | organization | config | global]
```

<Alert title="Nota">
  <markdown>
    Si decides hacer la copia de seguridad con el comando `docker compose run ...`, omitir los argumentos `-T` o `-e
        SENTRY_LOG_LEVEL=CRITICAL` hará que tu archivo de respaldo incluya líneas de registro,
    que luego tendrás que eliminar manualmente.
  </markdown>
</Alert>


<div id="advanced-usage">
  #### Uso avanzado
</div>

Si quieres un control más detallado sobre qué se incluye en la copia de seguridad y estás usando una versión `self-hosted`
igual o posterior a la 23.11.1, puedes usar el comando `./sentry-admin.sh export` en su lugar. En
particular, este comando te permite exportar solo un ***ámbito*** específico de datos. Hay cuatro
ámbitos:

- `User`: Exporta datos asociados únicamente a usuarios de Sentry, como sus correos electrónicos,
  permisos y credenciales de inicio de sesión. Las exportaciones en este ámbito se pueden filtrar
  por nombre de usuario. Las exportaciones en este ámbito se pueden crear con el comando de la CLI
  `./sentry-admin.sh export users ...`.
- `Organization`: Exporta datos pertenecientes a un conjunto de organizaciones de Sentry y a los usuarios
  que son miembros de ese conjunto. Las exportaciones en este ámbito se pueden filtrar por el slug de
  la organización. Las exportaciones en este ámbito se pueden crear con el comando de la CLI
  `./sentry-admin.sh export organizations ...`.
- `Config`: Exporta todas las configuraciones a nivel de instancia, como opciones globales y
  credenciales de administrador. Las exportaciones en este ámbito se pueden crear con el comando
  de la CLI `./sentry-admin.sh export config ...`.
- `Global`: Exporta todos los datos exportables. Las exportaciones en este ámbito se pueden crear
  con el comando de la CLI `./sentry-admin.sh export global ...`. Este comando es equivalente a
  ejecutar `backup.sh`.

Para obtener información más detallada, incluida la forma de cifrar una copia de seguridad, consulta `./sentry-admin.sh export
--help`.

<div id="encryption">
  #### Cifrado
</div>

La CLI `./sentry-admin.sh` admite el cifrado y descifrado de copias de seguridad con claves RSA asimétricas de 2048 bits. Estas claves pueden almacenarse manualmente como archivos accesibles desde el sistema de archivos local:

```shell
# Encripta y respalda usando claves almacenadas localmente.
./sentry-admin.sh export global /path/to/export.tar --encrypt-with /path/to/public/key/rsa.pub

# Desencripta y restaura usando claves almacenadas localmente.
./sentry-admin.sh import global /path/to/export.tar --decrypt-with /path/to/private/key/rsa.priv
```

Como alternativa, si usas el [Key Management Service](https://cloud.google.com/security/products/security-key-management?hl=en) de Google Cloud Platform para gestionar claves en tu nombre, puedes usar ese servicio directamente desde la CLI:

```shell
# Autentícate en Google Cloud (requiere tener instalada la CLI de `gcloud`):
gcloud auth login

# Crea un archivo JSON local que especifique una clave creada en https://cloud.google.com/kms/docs/create-key:
cat <<EOT >> /path/to/json/spec/for/your/key.json
{
    "project_id": "<YOUR_GCP_PROJECT_ID>",
    "location": "<YOUR_KEY_LOCATION>",
    "key_ring": "<YOUR_KEY_RING_NAME>",
    "key": "<YOUR_KEY_NAME>",
    "version": "<YOUR_KEY_VERSION>"
}
EOT

# Cifra y realiza una copia de seguridad con GCP KMS:
./sentry-admin.sh export global /path/to/export.tar --encrypt-with-gcp-kms /path/to/json/file/identifying/your/kms/key.json

# Descifra y restaura con GCP KMS:
./sentry-admin.sh import global /path/to/export.tar --decrypt-with-gcp-kms /path/to/json/spec/for/your/key.json
```

Ten en cuenta que, cuando se use cifrado, el archivo de salida será un archivo tar (`.tar`) en lugar de un único archivo JSON (`.json`).


<div id="restore">
  ### Restaurar
</div>

<Alert level="warning">
  ¡Restaurar una copia de seguridad parcial con este método hará que se eliminen los datos existentes en esas tablas!
</Alert>

Una vez que hayas generado una copia de seguridad, la forma más sencilla de restaurarla es colocarla en el directorio `sentry`
de tu repositorio principal `self-hosted`, junto a los archivos de configuración. Este directorio se monta automáticamente
en `/etc/sentry`, por lo que puedes ejecutar lo siguiente para restaurar la copia de seguridad:

```shell
# Si usas la versión self-hosted <= 23.3.0:
docker compose run --rm -T web import /etc/sentry/backup.json

# Si usas la versión self-hosted >= 23.3.1:
./scripts/restore.sh

# Si usas la versión self-hosted >= 24.1.0:
./scripts/restore.sh [user | organization | config | global]
```

Si no ves ningún error y el proceso termina con el código `0`, ¡felicidades! Acabas de restaurar tu copia de seguridad.

<Alert level="warning">
  Recomendamos encarecidamente restaurar tu copia de seguridad en la <strong>misma versión de Sentry</strong>
  y sobre una instalación nueva (base de datos vacía, pero con las migraciones ejecutadas). De lo contrario, es muy probable que
  aparezcan errores y podrías dañar tu base de datos.
</Alert>


<div id="advanced-usage">
  #### Uso avanzado
</div>

Si quieres un control más granular sobre lo que se restaura desde una copia de seguridad específica y estás usando una versión `self-hosted` igual o posterior a la 23.11.1, puedes usar el comando `./sentry-admin.sh import` en su lugar. Este comando te permite controlar el alcance de los datos que se importan, así como cómo interactúan con los datos ya cargados en la instancia.

Para obtener información más detallada, incluido cómo descifrar una copia de seguridad cifrada, consulta `./sentry-admin.sh export --help`.

<div id="full-backup">
  ## Respaldo completo
</div>

Otra forma de hacer copia de seguridad y restaurar Sentry es respaldar y restaurar todos los volúmenes de Docker que utiliza. Este
no es el flujo oficialmente admitido, así que hazlo bajo tu propio riesgo. Todos los volúmenes que contienen datos críticos a largo plazo
ya están definidos como volúmenes globales en el momento de la instalación y tienen el prefijo `sentry-`:

- `sentry-data`
- `sentry-postgres`
- `sentry-redis`
- `sentry-kafka`
- `sentry-clickhouse`
- `sentry-symbolicator`

<Alert title="Nota">

Hacer copia de seguridad y restaurar únicamente estos volúmenes debería recuperar todos los datos persistentes. Si también necesitas
respaldar datos en tránsito, te recomendamos respaldar cualquier volumen específico del proyecto que <code>docker
compose</code> cree automáticamente, normalmente con el prefijo <code>sentry_self_hosted_sentry-</code>.

</Alert>

Docker documenta en su sitio [cómo hacer copia de seguridad y restaurar
volúmenes](https://docs.docker.com/storage/volumes/#backup-restore-or-migrate-data-volumes). Puedes usar métodos diferentes siempre que los volúmenes se puedan volver a leer sin problemas.