---
title: Almacenamiento externo autogestionado
sidebar_title: Almacenamiento externo
sidebar_order: 90
---

<Alert title="Importante" level="warning">
    Esta documentación fue aportada por la comunidad. Sentry no ofrece soporte oficial para configuraciones autogestionadas más allá de la instalación predeterminada.
</Alert>

En algunos casos, no es viable almacenar los datos de Sentry en disco. A veces es mejor trasladarlos a un almacenamiento de objetos (como AWS S3 o Google Cloud Storage).

<Alert title="Nota">
    Después de cambiar los archivos de configuración, vuelve a ejecutar el script <code>./install.sh</code> para reconstruir y reiniciar los contenedores. Consulta la <Link to="/self-hosted/#configuration">sección de configuración</Link> para obtener más información.
</Alert>

<div id="sentry">
  ## Sentry
</div>

Sentry tiene una abstracción llamada “filestore” que se encarga de almacenar adjuntos, sourcemaps (artefactos de versión) y replays. La configuración de filestore para Sentry debe establecerse en el archivo `sentry/config.yml`.

**Importante:** el comando `sentry cleanup` no eliminará archivos almacenados en un sistema de almacenamiento externo como GCS o S3. Deberás configurar tu propio mecanismo de limpieza utilizando la política de retención de objetos de tu proveedor de almacenamiento. Esta política debe alinearse con `SENTRY_EVENTS_RETENTION_DAYS`, aunque puedes definir un valor distinto al establecido en el archivo de Docker Compose.

<div id="google-cloud-storage-backend">
  ### Backend de Google Cloud Storage
</div>

La configuración del backend de GCS apunta a `sentry.filestore.gcs.GoogleCloudStorage`. Deberás establecer la variable de entorno `GOOGLE_APPLICATION_CREDENTIALS`. Para obtener más información, consulta la [documentación de Google Cloud sobre cómo configurar la autenticación](https://cloud.google.com/storage/docs/reference/libraries#setting_up_authentication).

En tu archivo `sentry/config.yml`, deberás establecer lo siguiente:

```yaml
filestore.backend: "gcs"
filestore.options:
  bucket_name: "..."
```

Si realizaste la configuración mediante una clave de cuenta de servicio, deberás configurar tu archivo `docker-compose.yml` con lo siguiente:

```yaml
x-sentry-defaults: &sentry-defaults
  # ...
  environment:
    # El resto de las variables de entorno
    GOOGLE_APPLICATION_CREDENTIALS: "/run/secrets/service_account.json"
  volumes:
    # El resto de los volúmenes
    - "/path/to/service_account.json:/run/secrets/service_account.json:ro"
```


<div id="s3-backend">
  ### Backend de S3
</div>

<Alert title="Advertencia" level="warning">
  Aunque la compatibilidad con S3 está disponible, no se ha probado de forma exhaustiva y no la utiliza Sentry SaaS. Por lo tanto, es experimental y no cuenta con soporte oficial.
</Alert>

La configuración para un backend compatible con S3 debe apuntar a `sentry.filestore.s3.S3Boto3Storage`.

En tu archivo `sentry/config.yml`, tendrás que configurar lo siguiente:

```yaml
filestore.backend: 's3'
filestore.options:
  bucket_acl: 'private'
  default_acl: 'private'
  access_key: '<REDACTED>'
  secret_key: '<REDACTED>'
  bucket_name: 'my-bucket'
  region_name: 'auto'
  endpoint_url: 'https://<REDACTED>' # Si no usas AWS.
  addressing_style: 'path' # Para AWS S3 estándar, usa "auto" o "virtual". Para otras API compatibles con S3 como MinIO o Ceph, usa "path".
  signature_version: 's3v4'
```

Consulta la [configuración de botocore](https://botocore.amazonaws.com/v1/documentation/api/latest/reference/config.html) para ver los valores de configuración válidos.


<div id="vroom">
  ## Vroom
</div>

Vroom es el servicio que gestiona la generación de perfiles. De forma predeterminada, los datos de perfilado se guardan en el sistema de archivos local. En implementaciones autogestionadas, esto se debe configurar sobrescribiendo la variable de entorno `SENTRY_BUCKET_PROFILES`. También puede que sea necesario añadir variables de entorno adicionales, según el backend elegido.

**Importante:** el comando `sentry cleanup` no eliminará los archivos almacenados en un almacenamiento externo como GCS o S3. Deberás configurar tu propio mecanismo de limpieza utilizando la configuración de retención de objetos de tu proveedor de almacenamiento. Esto debe ajustarse en función de `SENTRY_EVENTS_RETENTION_DAYS`, aunque puedes establecer un valor diferente del definido en el archivo de Docker Compose.

<div id="google-cloud-storage-backend">
  ### Backend de Google Cloud Storage
</div>

Deberás establecer la variable de entorno `GOOGLE_APPLICATION_CREDENTIALS`. Para más información, consulta la [documentación de Google Cloud sobre cómo configurar la autenticación](https://cloud.google.com/storage/docs/reference/libraries#setting_up_authentication).

En tu archivo `docker-compose.yml`, tendrás que añadir lo siguiente (esto supone que la configuración se realiza mediante un archivo de cuenta de servicio):

```yaml
services:
  vroom:
    environment:
      # El resto de variables de entorno
      SENTRY_BUCKET_PROFILES: "gs://my-bucket"
      GOOGLE_APPLICATION_CREDENTIALS: "/run/secrets/service_account.json"
    volumes:
      # El resto de volúmenes
      - "/path/to/service_account.json:/run/secrets/service_account.json:ro"
```


<div id="s3-backend">
  ### Backend de S3
</div>

<Alert title="Advertencia" level="warning">
  Aunque hay compatibilidad con S3, no está completamente probada y no la usa Sentry SaaS. Por lo tanto, es experimental y no cuenta con soporte oficial.
</Alert>

En tu archivo `docker-compose.yml`, deberás añadir lo siguiente:

```yaml
services:
  vroom:
    environment:
      # El resto de las variables de entorno
      SENTRY_BUCKET_PROFILES: "s3://my-bucket?awssdk=v1&region=us-west-1&endpoint=amazonaws.com"
      # Para otras APIs compatibles con S3
      SENTRY_BUCKET_PROFILES: "s3://my-bucket?awssdk=v1&region=any-region&endpoint=minio.yourcompany.com&s3ForcePathStyle=true&disableSSL"
      AWS_ACCESS_KEY: "foobar"
      AWS_SECRET_KEY: "foobar"
      AWS_SESSION_TOKEN: "foobar" # (opcional)
```

Explicación adicional sobre las opciones del query string:

* `region`: La región de AWS para las solicitudes.
* `endpoint`: La URL del endpoint (solo el nombre de host o URI completamente cualificada).
* `disableSSL`: Un valor de &quot;true&quot; desactiva SSL al enviar solicitudes.
* `s3ForcePathStyle`: Un valor de &quot;true&quot; obliga a que la solicitud use direccionamiento con estilo de ruta.
