---
title: Renderizado de gráficos en el backend
og_image: /og-images/services-chartcuterie.png
---

El frontend de Sentry ofrece a los usuarios gráficos detallados e interactivos de
diversos tipos, muy adaptados al look and feel del producto Sentry.
Históricamente, estos gráficos solo han estado disponibles en la aplicación web.

Sin embargo, hay casos en los que sería muy valioso mostrar un gráfico en
algún contexto fuera de la aplicación. Por ejemplo:

* Despliegue en Slack de gráficos de Discover, notificaciones de Metric Alert, detalles
   de Issues u otros enlaces en Sentry donde pueda ser útil ver un gráfico
   en Slack.

 * Notificaciones y correos electrónicos de resumen. Visualizar tendencias como gráficos.

Afortunadamente, Sentry incluye compatibilidad con el servicio interno
[Chartcuterie](https://github.com/getsentry/chartcuterie) de NodeJS, que puede
generar gráficos en formato de imagen a través de una API HTTP. Los gráficos se generan
con la misma biblioteca [ECharts](https://github.com/apache/echarts) que se
usa en el frontend. Chartcuterie comparte código con el frontend de Sentry, lo que significa
que el look and feel de los gráficos puede mantenerse fácilmente entre el frontend
y los gráficos generados por Chartcuterie en el backend.

<div id="using-chartcuterie-in-sentrys-backend">
  ## Uso de Chartcuterie en el backend de Sentry
</div>

Generar gráficos con Chartcuterie es facilísimo.

Importa la función `generate_chart`, proporciona un tipo de gráfico y un objeto de datos, y obtén una URL pública de la imagen.

```python
from sentry.charts import generate_chart, ChartType

# La forma de los datos está determinada por el RenderDescriptor en el
# módulo de configuración para el ChartType que se está renderizando.
data = {}

chart_url = generate_chart(ChartType.MY_CHART_TYPE, data)
```


<div id="configuring-charts-for-rendering">
  ## Configuración de gráficos para el renderizado
</div>

Chartcuterie carga un módulo externo de JavaScript desde sentry.io que
determina cómo renderiza los gráficos. Este módulo configura directamente el objeto [`options`](https://echarts.apache.org/en/option.html) de ECharts, e incluye
transformaciones en los datos de las series proporcionados a Chartcuterie mediante una llamada `POST /render`.

Este módulo forma parte de getsentry/sentry y se puede encontrar en
[static/app/chartcuterie/config.tsx](https://github.com/getsentry/sentry/blob/master/static/app/chartcuterie/config.tsx).

<div id="service-initialization">
  ### Inicialización del servicio
</div>

Es posible configurar una función de inicialización opcional `init` que
se ejecuta al iniciarse el servicio. Esta función tiene acceso al objeto global
echarts de Chartcuterie y puede usarse para registrar utilidades en él (por ejemplo, [`registerMap`](https://echarts.apache.org/en/api.html#echarts.registerMap)).

<div id="adding-removing-chart-types">
  ### Agregar o eliminar tipos de gráficos
</div>

El renderizado de gráficos se configura **por “tipo de gráfico”**. Para cada tipo de
gráfico deberás declarar un nombre bien definido tanto en la aplicación de frontend como
en el módulo de gráficos del backend.

1. En el frontend, agrega un `ChartType` en
[static/app/charctuerie/types.tsx](https://github.com/getsentry/sentry/blob/master/static/app/chartcuterie/types.tsx).

2. Registra el `RenderDescriptor` del gráfico, que describe el aspecto
   y el comportamiento, así como las transformaciones de series, en
   [static/app/chartcuterie/config.tsx](https://github.com/getsentry/sentry/blob/master/static/app/chartcuterie/config.tsx).
   Puedes usar la función `register` para esto.

3. En el backend, agrega un `ChartType` correspondiente en el
   módulo [`sentry.charts.types`](https://github.com/getsentry/sentry/blob/master/src/sentry/charts/types.py).

4. Despliega tus cambios en Sentry. El módulo de configuración se propagará
   automáticamente a Chartcuterie en un plazo de 5 minutos.

   No necesitas desplegar Chartcuterie.

   <Alert level="warning">

   **NO** implementes funcionalidad que use tu nuevo tipo de gráfico al mismo
   tiempo que el módulo de configuración. Debido al retraso de propagación, no se garantiza que
   el nuevo tipo de gráfico esté disponible inmediatamente después de un
   despliegue.

   </Alert>

   El módulo de configuración incluye el SHA del commit desplegado en sentry.io, lo que
   permite a Chartcuterie comprobar si ha recibido un nuevo módulo de configuración
   en cada intervalo de sondeo.

<div id="running-chartcuterie-in-development">
  ## Ejecutar Chartcuterie en desarrollo
</div>

Para habilitar Chartcuterie en tu entorno de desarrollo local, primero actívalo en
tu `config.yml`:

```yml
# Habilitar chartcuterie
chart-rendering.enabled: true
```

Actualmente debes compilar manualmente el módulo de configuración en tu entorno de desarrollo.

```shell
pnpm build-chartcuterie-config
```

Luego puedes arrancar el devservice de Chartcuterie. Si el devservice no se inicia,
verifica que la clave chart-render.enabled esté configurada correctamente en `true` (usa `sentry
config get chart-rendering.enabled`).

```shell
devservices up --mode chartcuterie
```

Puedes verificar que el servicio se inició correctamente revisando los registros

```shell
docker logs -f sentry_chartcuterie
```

Algo que debería verse más o menos así

```
info: Usando estrategia de polling para resolver la configuración...
info: Polling cada 5s para obtener la configuración...
info: Servidor escuchando solicitudes de renderizado en el puerto 9090
info: Nueva configuración resuelta mediante polling: n estilos disponibles. {"version":"xxx"}
info: Polling de configuración cambiando a modo inactivo
info: Polling cada 300s para obtener la configuración...
```

Tu entorno de desarrollo ya está listo para realizar llamadas a una instancia local de
Chartcuterie.


<div id="updating-chart-types-locally">
  ### Actualizar los tipos de gráficos de forma local
</div>

Actualmente debes reconstruir el módulo de configuración con `pnpm
build-chartcuterie-config` cada vez que hagas un cambio. Es posible que esto mejore en el futuro.

<div id="how-it-works">
  ## Cómo funciona
</div>

Aquí tienes un par de diagramas del servicio Chartcuterie y de cómo
interactúa con el servidor de la aplicación de Sentry.

<div id="chartcuterie-bootup">
  ### Arranque de Chartcuterie
</div>

![secuencia de arranque](../img/chartcuterieBoot.png)

<div id="render-call-from-sentry">
  ### Llamada de renderizado desde Sentry
</div>

![llamada de renderizado](../img/chartcuterieCall.png)