# LLM-Friendly Documentation Spec

## Overview

Sentry docs are served as both HTML (for browsers) and Markdown (for LLMs). Every page at `docs.sentry.io/<path>` has a corresponding `docs.sentry.io/<path>.md` URL that returns a Markdown representation optimized for LLM consumption.

The Markdown exports are generated by `scripts/generate-md-exports.mjs` as a post-build step after both `doctree.json` and the Next.js build are complete.

## Content Negotiation

| Request                        | Response              |
| ------------------------------ | --------------------- |
| `GET /platforms/javascript`    | HTML page (browser)   |
| `GET /platforms/javascript.md` | Markdown file (LLM)   |
| `GET /index.md`                | Root navigation index |

The `.md` suffix triggers content negotiation. Markdown files are pre-generated at build time and served from `public/md-exports/` (and optionally synced to R2 CDN).

## How Markdown Pages Differ from HTML

Markdown exports are not just raw dumps of HTML content. They are adapted for LLM consumption:

| Aspect                   | HTML Page                             | Markdown Export                                                              |
| ------------------------ | ------------------------------------- | ---------------------------------------------------------------------------- |
| **Navigation**           | Sidebar, breadcrumbs, prev/next links | Appended navigation sections with categorized links                          |
| **Interactive elements** | Tabs, code switchers, copy buttons    | Removed (buttons stripped during conversion)                                 |
| **Titles**               | In `<title>` tag and breadcrumbs      | H1 heading at top of document                                                |
| **Links**                | Relative HTML paths                   | Absolute `.md` URLs (e.g., `https://docs.sentry.io/platforms/javascript.md`) |
| **Images**               | Relative paths                        | Absolute URLs                                                                |
| **Page structure**       | Header, sidebar, main content, footer | Title + main content + navigation sections                                   |
| **Description**          | HTML meta tag only                    | Injected as italic text after H1 heading                                     |

## Page Customization Architecture

The generation script has two layers of page customization, each suited to its use case:

### Layer 1: MDX Template Overrides (full page replacement)

For pages that need completely custom **content** (like root `index.md`), put an `.mdx` file in `md-overrides/`. These are authored like normal docs content but with custom components for dynamic data.

**Pipeline**: `MDX → React SSR → HTML → wrap in shell → existing HTML→MD worker pipeline`

The rendered HTML gets wrapped in a minimal `<title>` + `<link rel="canonical">` + `<div id="main">` structure that the existing pipeline expects. Workers process it through the same unified/rehype conversion as any other page — link rewriting, caching, R2 sync all work automatically.

**Directory structure:**

- `md-overrides/*.mdx` — overrides for `docs.sentry.io` pages
- `md-overrides/dev/*.mdx` — overrides for `develop.sentry.dev` pages

**Example** (`md-overrides/index.mdx`):

```mdx
---
title: "Sentry Documentation"
append_sections: false
---

Sentry is a developer-first application monitoring platform...

## Platforms

<PlatformList />

## Frameworks

<FrameworkGroups />

## Documentation

<DocSectionList exclude={["platforms", "_not-found"]} />

## Quick Links

- [Platform SDKs](/platforms) - Install Sentry for your language/framework
```

**Frontmatter fields:**

- `title` — becomes `<title>` in the HTML shell → H1 in the converted markdown
- `append_sections` — `false` to skip auto-appended navigation sections (default: `true`). Set to `false` when the template already includes all navigation via components.

The canonical URL is derived from the file path (`md-overrides/platforms.mdx` → `https://docs.sentry.io/platforms`).

**Available components** (close over `docTree`):

- `PlatformList` — renders `<ul>` of all visible platforms
- `FrameworkGroups` — renders platforms with nested guide lists
- `DocSectionList` — renders top-level doc sections (with `exclude` prop)

### Layer 2: Declarative Section Overrides (appended navigation)

For pages that need custom **navigation sections** appended after their converted content, use the `pageOverrides` table with declarative `sections` arrays.

```javascript
const pageOverrides = [
  {
    match: "platforms.md",
    build: (ctx) => buildPlatformsSection(ctx), // complex grouping needs custom build
  },
  {
    match: (ctx) =>
      ctx.pathParts[0] === "platforms" && ctx.pathParts.length === 2,
    sections: [
      { heading: "Frameworks", items: (ctx) => nodeLinks(ctx.node, "guides") },
      {
        heading: "Topics",
        items: (ctx) => childLinks(ctx, (p) => !p.includes("/guides/")),
      },
    ],
  },
];
```

**Override fields:**

- `match` — string for exact path match, or function receiving the context
- `sections` — array of `{heading, items}` for declarative sections (preferred)
- `build` — function returning markdown string (escape hatch for complex cases)

**Shared utilities:**

- `nodeLinks(node, subtreePath)` — links to visible children of a doctree subtree
- `childLinks(ctx, filter?)` — links from `ctx.children` with optional filter, sorted by `sidebar_order`
- `siblingGuideLinks(ctx)` — links to sibling guides for the same platform
- `renderSections(ctx, sections)` — renders section arrays to markdown
- `platformTitle(ctx)` — human-readable platform title from doctree

**Unified context object** passed to all match/build/section functions:

```javascript
{
  (docTree, relativePath, pathParts, node, children);
}
```

### Default Behavior

Pages without a matching override get a generic "Pages in this section" listing with:

- Proper titles from doctree (falling back to slug)
- Sorted by `sidebar_order`, then alphabetically by title
- Hidden/draft/versioned pages filtered out

## Description Injection

After all markdown files are generated and child sections are appended, the script injects frontmatter `description` values into the markdown output. This gives LLM agents a relevance signal in the first few lines of each page.

**How it works:**

1. For each `.md` file, look up the corresponding doctree node and read `frontmatter.description`
2. If a description exists, find the H1 line and insert `*{description}*` (italic) after it
3. Skip MDX override pages (they have custom intros)

**Result:**

```markdown
# Python | Sentry for Python

*Sentry's Python SDK enables automatic reporting of errors and performance data.*

## Prerequisites
```

The `injectDescription(markdown, description)` function finds the first `^# .+$` line and inserts the italic description after it. Files without an H1 or without a description are left unchanged. Modified files are uploaded to R2 if credentials are configured.

## Current Override Registry

### MDX Template Overrides

| File                         | Output           | Description                                                  |
| ---------------------------- | ---------------- | ------------------------------------------------------------ |
| `md-overrides/index.mdx`     | `index.md`       | Root docs index with platforms, frameworks, and doc sections |
| `md-overrides/dev/index.mdx` | `index.md` (dev) | Root developer docs index                                    |

### Section Overrides

| Pattern                                 | Description                                                       |
| --------------------------------------- | ----------------------------------------------------------------- |
| `platforms.md`                          | All platforms by title + frameworks grouped by platform           |
| `platforms/<sdk>.md`                    | "Frameworks" (guides with titles) + "Topics" (child pages sorted) |
| `platforms/<sdk>/guides/<framework>.md` | "Other Frameworks" (sibling guides) + "Topics"                    |

## Doc Tree Integration

The script loads `public/doctree.json` (generated by `scripts/generate-doctree.ts` earlier in the build pipeline). This provides:

- **Titles**: `frontmatter.sidebar_title || frontmatter.title` (instead of raw slugs)
- **Ordering**: `frontmatter.sidebar_order` for consistent sort order
- **Visibility**: Filters out `sidebar_hidden`, `draft`, and versioned (`__v`) pages
- **Hierarchy**: Parent/child relationships for building navigation

If `doctree.json` is unavailable, the script falls back to slug-based navigation (raw folder names, no ordering).

## Build Pipeline

```
pnpm generate-doctree    →  public/doctree.json
pnpm next build          →  .next/server/app/**/*.html
pnpm generate-md-exports →  public/md-exports/**/*.md  (+ R2 sync)
```

During `generate-md-exports`:

1. Load doctree
2. Render MDX templates from `md-overrides/` → HTML in `.next/cache/md-override-html/`
3. Discover HTML files, swapping source path for MDX override pages
4. Workers convert HTML → Markdown (parallel, cached, with R2 sync)
5. Append navigation sections to parent pages using `pageOverrides`
6. Inject frontmatter descriptions after H1 headings (skipping MDX overrides)

## Adding a New Override

### MDX Template Override (full page replacement)

1. Create an `.mdx` file in `md-overrides/` (or `md-overrides/dev/` for developer docs)
2. Add frontmatter with `title` and `append_sections: false` if the template handles its own navigation
3. Use available components (`PlatformList`, `FrameworkGroups`, `DocSectionList`) or add new ones in `buildMdxComponents()`
4. Build and verify: check the output in `public/md-exports/`

### Section Override (appended navigation)

1. Add an entry to the `pageOverrides` array in `scripts/generate-md-exports.mjs`
2. Use `sections` array for declarative overrides, or `build` function for complex cases
3. The `match` field determines which pages use the override (string or function)
4. Build and verify: check the output in `public/md-exports/`

## Verification

After `pnpm build`, inspect:

```bash
# Root index
cat public/md-exports/index.md

# Platforms index
cat public/md-exports/platforms.md

# A platform page
cat public/md-exports/platforms/javascript.md

# A guide page
cat public/md-exports/platforms/javascript/guides/nextjs.md

# A generic section page
cat public/md-exports/product.md
```

Verify that:

- Titles are human-readable (not raw slugs)
- Links use absolute `.md` URLs
- Pages are sorted by sidebar_order
- Hidden/draft pages are excluded
- Frameworks are listed by proper name (e.g., "Next.js" not "nextjs")
