# LLM-Friendly Documentation Spec

## Overview

Sentry docs are served as both HTML (for browsers) and Markdown (for LLMs). Every page at `docs.sentry.io/<path>` has a corresponding `docs.sentry.io/<path>.md` URL that returns a Markdown representation optimized for LLM consumption.

The Markdown exports are generated by `scripts/generate-md-exports.mjs` as a post-build step after both `doctree.json` and the Next.js build are complete.

## Content Negotiation

| Request | Response |
|---------|----------|
| `GET /platforms/javascript` | HTML page (browser) |
| `GET /platforms/javascript.md` | Markdown file (LLM) |
| `GET /index.md` | Root navigation index |

The `.md` suffix triggers content negotiation. Markdown files are pre-generated at build time and served from `public/md-exports/` (and optionally synced to R2 CDN).

## How Markdown Pages Differ from HTML

Markdown exports are not just raw dumps of HTML content. They are adapted for LLM consumption:

| Aspect | HTML Page | Markdown Export |
|--------|-----------|-----------------|
| **Navigation** | Sidebar, breadcrumbs, prev/next links | Appended navigation sections with categorized links |
| **Interactive elements** | Tabs, code switchers, copy buttons | Removed (buttons stripped during conversion) |
| **Titles** | In `<title>` tag and breadcrumbs | H1 heading at top of document |
| **Links** | Relative HTML paths | Absolute `.md` URLs (e.g., `https://docs.sentry.io/platforms/javascript.md`) |
| **Images** | Relative paths | Absolute URLs |
| **Page structure** | Header, sidebar, main content, footer | Title + main content + navigation sections |

## Page Customization Architecture

The generation script has two override registries for customizing output on a per-page basis:

### Content Overrides (full page replacement)

For pages that need completely custom content (e.g., root `index.md`), register a `contentOverride`. The override replaces the entire worker-generated Markdown with custom content.

```javascript
const contentOverrides = [
  {
    match: (relativePath) => relativePath === 'index.md',
    build: (docTree, existingContent, context) => {
      // Return full page content as a string
      return `# Sentry Documentation\n...`;
    },
  },
];
```

**Parameters:**
- `match(relativePath)` — return `true` if this override applies to the given path
- `build(docTree, existingContent, context)` — return the full page content
  - `docTree` — parsed `doctree.json` (or `null` if unavailable)
  - `existingContent` — the worker-generated Markdown (can be used as base)
  - `context.allPaths` — list of all generated `.md` paths

### Section Overrides (appended navigation)

For pages that need custom navigation sections appended to the converted content, register a `sectionOverride`. These are appended after the main content.

```javascript
const sectionOverrides = [
  {
    match: (pathParts, parentPath) => parentPath === 'platforms.md',
    build: (docTree, parentParts, parentNode, children) => {
      // Return markdown string to append
      return '\n## Platforms\n\n- [JavaScript](...)\n';
    },
  },
];
```

**Parameters:**
- `match(pathParts, parentPath)` — path segments array and full parent path (e.g., `['platforms', 'javascript']`, `'platforms/javascript.md'`)
- `build(docTree, parentParts, parentNode, children)` — return the section to append
  - `parentParts` — path segments for the parent page
  - `parentNode` — doctree node for the parent (if found)
  - `children` — list of child `.md` paths that belong to this parent

### Default Behavior

Pages without a matching override get a generic "Pages in this section" listing with:
- Proper titles from doctree (falling back to slug)
- Sorted by `sidebar_order`, then alphabetically by title
- Hidden/draft/versioned pages filtered out

## Current Override Registry

### Content Overrides

| Pattern | Description |
|---------|-------------|
| `index.md` | Root documentation index with platforms, frameworks, and doc sections |

### Section Overrides

| Pattern | Description |
|---------|-------------|
| `platforms.md` | All platforms by title + frameworks grouped by platform |
| `platforms/<sdk>.md` | "Frameworks" (guides with titles) + "Topics" (child pages sorted) |
| `platforms/<sdk>/guides/<framework>.md` | "Other Frameworks" (sibling guides) + "Topics" |

## Doc Tree Integration

The script loads `public/doctree.json` (generated by `scripts/generate-doctree.ts` earlier in the build pipeline). This provides:

- **Titles**: `frontmatter.sidebar_title || frontmatter.title` (instead of raw slugs)
- **Ordering**: `frontmatter.sidebar_order` for consistent sort order
- **Visibility**: Filters out `sidebar_hidden`, `draft`, and versioned (`__v`) pages
- **Hierarchy**: Parent/child relationships for building navigation

If `doctree.json` is unavailable, the script falls back to slug-based navigation (raw folder names, no ordering).

## Build Pipeline

```
yarn generate-doctree    →  public/doctree.json
yarn next build          →  .next/server/app/**/*.html
yarn generate-md-exports →  public/md-exports/**/*.md  (+ R2 sync)
```

## Adding a New Override

1. Write a builder function in `scripts/generate-md-exports.mjs`
2. Add an entry to `contentOverrides` (full replacement) or `sectionOverrides` (appended section)
3. The match function determines which pages use the override
4. Build and verify: check the output in `public/md-exports/`

## Verification

After `yarn build`, inspect:

```bash
# Root index
cat public/md-exports/index.md

# Platforms index
cat public/md-exports/platforms.md

# A platform page
cat public/md-exports/platforms/javascript.md

# A guide page
cat public/md-exports/platforms/javascript/guides/nextjs.md

# A generic section page
cat public/md-exports/product.md
```

Verify that:
- Titles are human-readable (not raw slugs)
- Links use absolute `.md` URLs
- Pages are sorted by sidebar_order
- Hidden/draft pages are excluded
- Frameworks are listed by proper name (e.g., "Next.js" not "nextjs")
